# 进程、线程、协程

进程、线程、协程是啥？网上有很多生动形象的例子，我个人认为，搞这么多花里胡哨的，目的就一个：最大化利用资源。

注：进程、线程不是我想写的重点，协程才是，但不提一下，感觉就像吃🍔🍟没有🥤一样奇怪。

# 令打工人悲伤的故事

**以下故事纯属虚构，如有雷同纯属巧合**

## 进程

对于进程而言，合理利用资源，在本文中是指cpu的时间资源。

完成一件事情需要很多步骤，一个人可以一个步骤做完再进行下一步，假设cpu也是这样，就会浪费一些时间，因为cpu太快，非常快，而寄存器比较慢，内存更慢，硬盘慢的你想给它一脚。

按照前面的设定，在IO操作时，cpu就躺着休息了，因为这个步骤没做完，下一步也不做。时间就浪费在了这里。所以为了合理利用cpu等待的这段时间。可以让cpu先提前做其他步骤。（打工人写到这里，眼眶都湿润了）

那就把各个步骤，放到不同的进程去执行，cpu在执行一个步骤，遇到了耗时等待的io时，就去执行另一个步骤，也就是执行另一个进程，但这时又发现一个问题，cpu确实把等待的时间利用起来了，但是有一部分时间不是在执行进程，而是在做上下文切换。

举个不恰当的例子：

你去找张三，让张三帮你写个网页，但张三家停电了，得出去交个电费 (IO耗时操作)，让你等他20分钟。你想，我先去找李四吧，先让李四把后台的协议先定下来，从张三到李四家花了5分钟，和李四的讨论花了10分钟。然后你回去找张三，到张三家里时，张三正好交完电费回来了。

20分钟没有在张三家里白等，但是你花费了10分钟在张三到李四家往返，10分钟你都可以让王五再改几版稿子，赵六再提几个场景了，老子分分钟几百万上下？这张三和李四就不能住一起吗？在这里，张三和李四的房子都是属于进程，进程间的切换稍微耗费点时间。

## 线程

所以你就租了栋楼，让张三李四住一起，一人一层，这样找他们的时候就简单了！对了，把王五赵六也叫上吧。在这里，我们把这栋楼看做进程，张三和李四看做线程。在这里，找张三找李四都快多了。（打工人写到这里，眼泪已经留下来了）

随着业务越做越大，赵六已经很久没有提出有意思的功能了，但用户量越来越大，为了不让用户有时间关注其他的竞品，你只能让赵六搞些小玩意，时不时给用户一点小惊喜，提升一点用户对产品的关注度。总得给他们一点话题聊嘛，比如踢踢对方就能让对方的头像飞出屏幕。

但张三一直找你说：踢踢功能不建议加表情包吧？加了后如果有人加个💩，那不是💩💩满屏飞？这时候你都烦死他了，赵六说要做就是要做，这能增加用户的趣味性！这些程序员真的是啥都不懂。

这就和应付八大姑七大姨一样的，你时不时给他们透露一下自己又挣了多少钱，她们就会觉得你很出息，那她们对你的评价肯比你那个老是跑去南极的表哥好，即使你那个表哥很受00后小姐姐的喜爱。

然后李四一直找你说在网站屏蔽了用户发表的第三方网站链接不好吧？这不是用户自己的圈子吗？只要不违法，想发什么就发什么才对吧？听到这里你都不想鸟李四了，他格局太小了，都不知道从更深一层去考虑。

这个时候你就觉得手下的人真烦，每个人抢着都找你叽叽喳喳（一些操作系统的线程执行是抢占式的），关键是一遍聊还要一边查资料，简直浪费你时间，于是你让秘书（操作系统）安排一下，每个人最多只有两分钟的时间，当然，级别高的可以直接找你，超时也允许（一些操作系统是优先级高的可以是抢占式的，而普通线程是非强占式的）。

在秘书的安排下（调度），张三李四们就按秘书的安排来你的办公室，和你逼逼，一次逼逼的时间也就那么长，谈不完就下次再谈。但后来你发现，本来下一个到张三，但张三从工位到你办公室也要一点点时间，作为一个一天只睡4个小时的最佳老板。你怎么能忍受这些时间的浪费？这个例子可能举的不好，其实是资源竞争的问题，多个线程在执行时，必然会对同一个资源进行竞争。这就像多个员工去竞争你这个老板一样，所以需要对共享资源进行加锁，而加锁就会涉及到线程状态的切换，这里是会浪费时间的。

# 协程

于是你引进了一套在线会议系统，你只需要按照秘书的安排，和对应的人开会就好，这样就减少了他们过来你办公室的时间。秘书通知某个员工到他了，再让其他所有员工等待。这部分也是浪费了一点时间。

那如果允许员工之间提前沟通时间，因为他们知道自己什么时候有时间，他们可以主动让出这个开会的时间给其他人，并提前定好要开会的时间，一到时间直接开会，省去了秘书的通知，时间又节省了一点。这就是协程的主动让出cpu所有权的行为。当然，由于在线会议的引入，虽然你和一万个员工在开会，但对你而言，你所面对都是同一个屏幕。这里类比的可能也不恰当，但要知道的是，有些时候不管有多少个协程，对cpu而言可能就只有一个线程。所以在这里，张三和李四已经不是线程的概念了，而是协程的概念。

故事差不多就这样，在这里我们关注到对于进程和线程的资源浪费，本质上是时间的浪费，而时间大部分就是花费在了空间上，同时合理的调度也是能省出一部分时间。

所以进程，线程等概念，我感觉可以当做是时间的概念，举个例子：爽子一天挣208万，那你就可以用一爽比作208万，因为从某个层面而言，一爽和208万是等价的。当然你会举一反三：一东。

# 协程肉眼可见的好，在哪里？

从上文中，在这种等待多的情况下，大家自主的让出cpu时间片会更高效。你可能会有一丢丢疑问，那几个员工都想要同一个时间呢？那这样的让出还有意义吗？有的，因为不互相协调时间的话，那就最差的情况就是：大家都被安排在自己忙的时间（io），但如果协调好时间的话，就可以减少这种情况。这种就是io密集型的场景，采用协作的方式能大大减少时间的浪费。

大家主动让出的这种行为就是协作，而不是像一开始那样的都去抢占时间片。这里的让出，其实就是挂起的意思，而挂起就意味着某个时间后还是要恢复的，这里和线程的状态切换很像。

但从上面的故事中可以知道：从张三到李四的会议安排，是由你的秘书决定的，而主动让出和什么时候开会，是由员工决定的，这里的差别很大。在第二种方式下，你的秘书可以省去很多找员工沟通的时间。

而如果张三李四的工作就是负责和你开会，不需要写代码，不需要画稿子，不需要画原型，那让张三李四上线下线会议的行为反而会影响张三和李四的工作效率，这种就是计算密集型的情况，串行比并行高效。

# 协程的实现差异

某天合作伙伴孙总过来你这参观，发现你管理员工的方法特别好，回去后马上尝试搞一套。也请了一个秘书，市场上很多这种管理专业的人才，这些人才的培养早有体系，找一个很简单，所以孙总的公司很快就实现了通过秘书安排会议。这里是在说不同操作系统线程的api设计大致相同。

但他遇到了个问题：他发现他的员工的协同能力比较差（也可能他发现他员工的协同能力很强，然后向你得意洋洋的炫耀）。员工的岗位，所掌握的技能，性格，素质水平等方面的不同，不经过培训，很难一下子要求所有人做到很好的协同，培训的方式和效果也不一样。所以有的公司可能最终协作的方案是A，有的公司协同方案是B。这里其实是在表达，协程是语言层面上的东西，每种语言的实现方式都不一样，效果也不一样。

协程也分有栈协程和无栈协程。说到栈就熟悉了是吧，常说调用栈调用栈，这里的有栈其实就是因为一些协程间可能有调用关系，有个大佬讲的很好：[有栈协程和无栈协程](https://blog.csdn.net/weixin_43705457/article/details/106924435)

# 协程怎么让你爽起来？

