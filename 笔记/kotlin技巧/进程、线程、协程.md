# Kotlinåç¨‹æµ…è°ˆ

è¿›ç¨‹ã€çº¿ç¨‹ã€åç¨‹æ˜¯å•¥ï¼Ÿç½‘ä¸Šæœ‰å¾ˆå¤šç”ŸåŠ¨å½¢è±¡çš„ä¾‹å­ï¼Œæˆ‘ä¸ªäººè®¤ä¸ºï¼Œæè¿™ä¹ˆå¤šèŠ±é‡Œèƒ¡å“¨çš„ï¼Œç›®çš„å°±ä¸€ä¸ªï¼šæœ€å¤§åŒ–åˆ©ç”¨èµ„æºã€‚

æ³¨ï¼šè¿›ç¨‹ã€çº¿ç¨‹ä¸æ˜¯æˆ‘æƒ³å†™çš„é‡ç‚¹ï¼Œåç¨‹æ‰æ˜¯ï¼Œä½†ä¸æä¸€ä¸‹å‰é¢ä¸¤ä¸ªï¼Œæ„Ÿè§‰å°±åƒåƒğŸ”ğŸŸæ²¡æœ‰ğŸ¥¤ä¸€æ ·å¥‡æ€ªã€‚

# ä»¤æ‰“å·¥äººæ‚²ä¼¤çš„æ•…äº‹

**æœ¬æ–‡åºŸè¯è¾ƒå¤šï¼Œä¸å–œå‹¿å–·ï¼Œè€å¿ƒçœ‹ä¸‹å»ï¼Œè¯´ä¸å®šä¼šæœ‰æ„æƒ³ä¸åˆ°çš„æ”¶è·**

## è¿›ç¨‹

å¯¹äºè¿›ç¨‹è€Œè¨€ï¼Œåˆç†åˆ©ç”¨çš„èµ„æºåœ¨æœ¬æ–‡ä¸­æ˜¯æŒ‡cpuçš„æ—¶é—´èµ„æºã€‚

å®Œæˆä¸€ä»¶äº‹æƒ…éœ€è¦å¾ˆå¤šæ­¥éª¤ï¼Œæ‰§è¡Œæ­¥éª¤æœ‰å¾ˆå¤šç­–ç•¥ï¼Œå‡è®¾ä½ çš„ç­–ç•¥æ˜¯one by oneï¼šå¿…é¡»ä¸€ä¸ªæ­¥éª¤åšå®Œå†è¿›è¡Œä¸‹ä¸€æ­¥ã€‚

å¦‚æœcpuä¹Ÿåƒä½ ä¸€æ ·çš„ç­–ç•¥ï¼Œé‚£åœ¨å¯¹å¯„å­˜å™¨ï¼Œå†…å­˜ï¼Œç¡¬ç›˜è¿›è¡ŒIOæ“ä½œæ—¶ï¼Œcpuå°±èººç€ä¼‘æ¯äº†ï¼å› ä¸ºcpuå¤ªå¿«ï¼Œéå¸¸å¿«ï¼Œè€Œå¯„å­˜å™¨æ¯”è¾ƒæ…¢ï¼Œå†…å­˜æ›´æ…¢ï¼Œç¡¬ç›˜æ›´æ›´æ…¢ï¼Œæ‰€ä»¥cpuåªèƒ½ç­‰æ•°æ®ä¼ è¾“å®Œï¼Œæ—¶é—´å°±æµªè´¹åœ¨äº†è¿™é‡Œã€‚

ä¸ºäº†åˆç†åˆ©ç”¨cpuç­‰å¾…çš„è¿™æ®µæ—¶é—´ã€‚å¯ä»¥è®©cpuå…ˆæå‰åšå…¶ä»–æ­¥éª¤ã€‚ï¼ˆæ‰“å·¥äººå†™åˆ°è¿™é‡Œï¼Œçœ¼çœ¶éƒ½æ¹¿æ¶¦äº†ï¼‰

![image](https://github.com/BAByte/pic/blob/master/images12213.jpeg?raw=true)

é‚£å°±æŠŠå„ä¸ªæ­¥éª¤ï¼Œæ”¾åˆ°ä¸åŒçš„è¿›ç¨‹å»æ‰§è¡Œï¼Œcpuåœ¨æ‰§è¡Œä¸€ä¸ªæ­¥éª¤ï¼Œé‡åˆ°äº†è€—æ—¶ç­‰å¾…çš„ioæ—¶ï¼Œå°±å»æ‰§è¡Œå¦ä¸€ä¸ªæ­¥éª¤ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œå¦ä¸€ä¸ªè¿›ç¨‹ï¼Œä½†è¿™æ—¶åˆå‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œcpuç¡®å®æŠŠç­‰å¾…çš„æ—¶é—´åˆ©ç”¨èµ·æ¥äº†ï¼Œä½†æ˜¯æœ‰ä¸€éƒ¨åˆ†æ—¶é—´å¹¶æ²¡æœ‰æ‰§è¡Œè¿›ç¨‹é‡Œé¢çš„ä»£ç ï¼Œè€Œæ˜¯åœ¨åšè¿›ç¨‹ç¯å¢ƒçš„åˆ‡æ¢ã€‚

ä¸¾ä¸ªä¸æ°å½“çš„ä¾‹å­ï¼š

ä½ å»æ‰¾å¼ ä¸‰ï¼Œè®©å¼ ä¸‰å¸®ä½ å†™ä¸ªç½‘é¡µï¼Œä½†å¼ ä¸‰è¯´ä½ æçš„è¿™ä¸ªåŠŸèƒ½æŠ€æœ¯ä¸Šéœ€è¦è°ƒç ”ä¸€ä¸‹ (IOè€—æ—¶æ“ä½œ)ï¼Œè®©ä½ ç­‰ä»–20åˆ†é’Ÿã€‚ä½ æƒ³ï¼Œæˆ‘å…ˆå»æ‰¾æå››å§ï¼Œå…ˆè®©æå››æŠŠåå°çš„åè®®å…ˆå®šä¸‹æ¥ï¼Œä»å¼ ä¸‰åˆ°æå››å®¶èŠ±äº†5åˆ†é’Ÿï¼Œå’Œæå››çš„è®¨è®ºèŠ±äº†10åˆ†é’Ÿã€‚ç„¶åä½ å›å»æ‰¾å¼ ä¸‰ï¼Œåˆ°å¼ ä¸‰å®¶é‡Œæ—¶ï¼Œå¼ ä¸‰æ­£å¥½è°ƒç ”å®Œäº†ã€‚

20åˆ†é’Ÿæ²¡æœ‰åœ¨å¼ ä¸‰å®¶é‡Œç™½ç­‰ï¼Œä½†æ˜¯ä½ èŠ±è´¹äº†10åˆ†é’Ÿåœ¨å¼ ä¸‰åˆ°æå››å®¶å¾€è¿”ï¼Œ10åˆ†é’Ÿä½ éƒ½å¯ä»¥è®©ç‹äº”å†æ”¹å‡ ç‰ˆç¨¿å­ï¼Œèµµå…­å†æå‡ ä¸ªåœºæ™¯äº†ï¼Œè€å­åˆ†åˆ†é’Ÿå‡ åä¸‡ä¸Šä¸‹ï¼Œè¿™å¼ ä¸‰å’Œæå››å°±ä¸èƒ½ä½ä¸€èµ·å—ï¼Ÿåœ¨è¿™é‡Œï¼Œå¼ ä¸‰å’Œæå››çš„æˆ¿å­éƒ½æ˜¯å±äºè¿›ç¨‹ï¼Œè¿›ç¨‹é—´çš„åˆ‡æ¢ç¨å¾®è€—è´¹ç‚¹æ—¶é—´ã€‚

## çº¿ç¨‹

ä½ è§‰å¾—æ—¶é—´éƒ½æµªè´¹åœ¨æ²¡æœ‰ä»·å€¼çš„åœ°æ–¹ï¼Œæ‰€ä»¥ä½ å°±ç§Ÿäº†æ ‹æ¥¼ï¼Œè®©å¼ ä¸‰æå››ä½ä¸€èµ·ï¼Œä¸€äººä¸€å±‚ï¼Œè¿™æ ·æ‰¾ä»–ä»¬çš„æ—¶å€™å°±ç®€å•äº†ï¼å¯¹äº†ï¼ŒæŠŠç‹äº”èµµå…­ä¹Ÿå«ä¸Šå§ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æŠŠè¿™æ ‹æ¥¼çœ‹åšè¿›ç¨‹ï¼Œå¼ ä¸‰å’Œæå››çœ‹åšçº¿ç¨‹ã€‚è¿™ä¸ªæ—¶å€™ä½ æ‰¾å¼ ä¸‰æ‰¾æå››éƒ½å¿«å¤šäº†ã€‚ï¼ˆæ‰“å·¥äººå†™åˆ°è¿™é‡Œï¼Œçœ¼æ³ªå·²ç»æµä¸‹æ¥äº†ï¼‰

![image](https://github.com/BAByte/pic/blob/master/16152598991897275.jpeg?raw=true)

éšç€ä¸šåŠ¡è¶Šåšè¶Šå¤§ï¼Œè¶Šæ¥è¶Šå¤šçš„åº”é…¬ï¼Œä½ è§‰å¾—æ‰‹ä¸‹çš„äººçœŸçƒ¦ï¼Œæ¯ä¸ªäººæŠ¢ç€éƒ½æ‰¾ä½ å½å½å–³å–³ï¼ˆä¸€äº›æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹æ‰§è¡Œæ˜¯æŠ¢å å¼çš„ï¼‰ï¼Œç®¡ç†æ—¶é—´æˆä¸ºäº†ä½ çš„é¦–è¦é—®é¢˜ã€‚äºæ˜¯ä½ è¯·äº†ä¸ªç§˜ä¹¦ï¼Œä¼šè®®çš„äº‹æƒ…è®©ç§˜ä¹¦ï¼ˆæ“ä½œç³»ç»Ÿï¼‰å®‰æ’ä¸€ä¸‹ï¼Œæ¯ä¸ªäººæœ€å¤šåªæœ‰ä¸¤åˆ†é’Ÿçš„æ—¶é—´ï¼Œå½“ç„¶ï¼Œçº§åˆ«é«˜çš„å¯ä»¥ç›´æ¥æ‰¾ä½ ï¼Œè¶…æ—¶ä¹Ÿå…è®¸ï¼ˆä¸€äº›æ“ä½œç³»ç»Ÿæ˜¯ä¼˜å…ˆçº§é«˜çš„å¯ä»¥æ˜¯æŠ¢å å¼çš„ï¼Œè€Œæ™®é€šçº¿ç¨‹æ˜¯éå¼ºå å¼çš„ï¼‰ã€‚

åœ¨ç§˜ä¹¦çš„å®‰æ’ä¸‹ï¼ˆè°ƒåº¦ï¼‰ï¼Œå¼ ä¸‰æå››ä»¬å°±æŒ‰ç§˜ä¹¦çš„å®‰æ’æ¥ä½ çš„åŠå…¬å®¤ï¼Œå’Œä½ å¼€ä¼šï¼Œä¸€æ¬¡çš„æ—¶é—´ä¹Ÿå°±é‚£ä¹ˆé•¿ï¼Œè°ˆä¸å®Œå°±ä¸‹æ¬¡å†è°ˆã€‚ä½†åæ¥ä½ å‘ç°ï¼Œä¸‹ä¸€ä¸ªåˆ°å¼ ä¸‰ï¼Œä½†å¼ ä¸‰ä»å·¥ä½åˆ°ä½ åŠå…¬å®¤ä¹Ÿè¦ä¸€ç‚¹ç‚¹æ—¶é—´ã€‚ä½ æ€ä¹ˆèƒ½å¿å—è¿™äº›æ—¶é—´çš„æµªè´¹ï¼Ÿè¿™ä¸ªä¾‹å­å¯èƒ½ä¸¾çš„ä¸å¥½ï¼Œå…¶å®æ˜¯èµ„æºç«äº‰å’Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„é—®é¢˜ï¼Œå¤šä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œæ—¶ï¼Œå¿…ç„¶ä¼šå¯¹åŒä¸€ä¸ªèµ„æºè¿›è¡Œç«äº‰ã€‚è¿™å°±åƒå¤šä¸ªå‘˜å·¥å»ç«äº‰ä½ è¿™ä¸ªè€æ¿ä¸€æ ·ï¼Œæ‰€ä»¥éœ€è¦å¯¹å…±äº«èµ„æºè¿›è¡ŒåŠ é”ï¼Œè€ŒåŠ é”å°±ä¼šæ¶‰åŠåˆ°çº¿ç¨‹çŠ¶æ€çš„åˆ‡æ¢ï¼Œè¿™é‡Œæ˜¯ä¼šæµªè´¹æ—¶é—´çš„ã€‚åŒæ—¶çº¿ç¨‹åˆ‡æ¢ä¹Ÿæµªè´¹äº†ä¸€ä¸¢ä¸¢æ—¶é—´ã€‚

## åç¨‹

äºæ˜¯ä½ å¼•è¿›äº†ä¸€å¥—åœ¨çº¿ä¼šè®®ç³»ç»Ÿï¼Œä½ åªéœ€è¦æŒ‰ç…§ç§˜ä¹¦çš„å®‰æ’ï¼Œå’Œå¯¹åº”çš„äººå¼€ä¼šå°±å¥½ï¼Œè¿™æ ·å°±å‡å°‘äº†ä»–ä»¬è¿‡æ¥ä½ åŠå…¬å®¤çš„æ—¶é—´ã€‚ç§˜ä¹¦é€šçŸ¥æŸä¸ªå‘˜å·¥åˆ°ä»–äº†ï¼Œå†è®©å…¶ä»–æ‰€æœ‰å‘˜å·¥ç­‰å¾…ã€‚è¿™ä¹Ÿæµªè´¹äº†ä¸€ç‚¹æ—¶é—´ã€‚

é‚£å¦‚æœå…è®¸å‘˜å·¥ä¹‹é—´æå‰æ²Ÿé€šæ—¶é—´ï¼Œå› ä¸ºä»–ä»¬çŸ¥é“è‡ªå·±ä»€ä¹ˆæ—¶å€™æœ‰æ—¶é—´ï¼Œä»–ä»¬å¯ä»¥ä¸»åŠ¨è®©å‡ºè¿™ä¸ªå¼€ä¼šçš„æ—¶é—´ç»™å…¶ä»–äººï¼Œå¹¶æå‰å®šå¥½è¦å¼€ä¼šçš„æ—¶é—´ï¼Œä¸€åˆ°æ—¶é—´ç›´æ¥å¼€ä¼šï¼Œçœå»äº†ç§˜ä¹¦çš„é€šçŸ¥ï¼Œæ—¶é—´åˆèŠ‚çœäº†ä¸€ç‚¹ã€‚è¿™å°±æ˜¯åç¨‹çš„ä¸»åŠ¨è®©å‡ºcpuæ‰€æœ‰æƒçš„è¡Œä¸ºã€‚å½“ç„¶ï¼Œç”±äºåœ¨çº¿ä¼šè®®çš„å¼•å…¥ï¼Œè™½ç„¶ä½ å’Œä¸€ä¸‡ä¸ªå‘˜å·¥åœ¨å¼€ä¼šï¼Œä½†å¯¹ä½ è€Œè¨€ï¼Œä½ æ‰€é¢å¯¹éƒ½æ˜¯åŒä¸€ä¸ªå±å¹•ã€‚è¿™é‡Œç±»æ¯”çš„å¯èƒ½ä¹Ÿä¸æ°å½“ï¼Œä½†è¦çŸ¥é“çš„æ˜¯ï¼Œæœ‰äº›æ—¶å€™ä¸ç®¡æœ‰å¤šå°‘ä¸ªåç¨‹ï¼Œå¯¹cpuè€Œè¨€å¯èƒ½å°±åªæœ‰ä¸€ä¸ªçº¿ç¨‹ã€‚æ‰€ä»¥åœ¨è¿™é‡Œï¼Œå¼ ä¸‰å’Œæå››å·²ç»ä¸æ˜¯çº¿ç¨‹çš„æ¦‚å¿µäº†ï¼Œè€Œæ˜¯åç¨‹çš„æ¦‚å¿µã€‚

æ•…äº‹å·®ä¸å¤šå°±è¿™æ ·ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å…³æ³¨åˆ°å¯¹äºè¿›ç¨‹å’Œçº¿ç¨‹çš„èµ„æºæµªè´¹ï¼Œæœ¬è´¨ä¸Šæ˜¯æ—¶é—´çš„æµªè´¹ï¼Œè€Œæ—¶é—´å¤§éƒ¨åˆ†å°±æ˜¯èŠ±è´¹åœ¨äº†ç©ºé—´ä¸Šï¼ŒåŒæ—¶åˆç†çš„è°ƒåº¦ä¹Ÿæ˜¯èƒ½çœå‡ºä¸€éƒ¨åˆ†æ—¶é—´ã€‚

æ‰€ä»¥è¿›ç¨‹ï¼Œçº¿ç¨‹ç­‰æ¦‚å¿µï¼Œæˆ‘æ„Ÿè§‰å¯ä»¥å½“åšæ˜¯æ—¶é—´çš„æ¦‚å¿µï¼Œä¸¾ä¸ªä¾‹å­ï¼šçˆ½å­ä¸€å¤©æŒ£208ä¸‡ï¼Œé‚£ä½ å°±å¯ä»¥ç”¨ä¸€çˆ½æ¯”ä½œ208ä¸‡ï¼Œå› ä¸ºä»æŸä¸ªå±‚é¢è€Œè¨€ï¼Œä¸€çˆ½å’Œ208ä¸‡æ˜¯ç­‰ä»·çš„ã€‚å½“ç„¶ä½ ä¼šä¸¾ä¸€åä¸‰ï¼šä¸€ä¸œã€‚

# ç”¨äº†åç¨‹åï¼Œä¸€å®šèƒ½ä½ å¥½ï¼Œå¥¹ä¹Ÿå¥½å—ï¼Ÿ

ä»ä¸Šæ–‡ä¸­ï¼Œåœ¨è¿™ç§ç­‰å¾…å¤šçš„æƒ…å†µä¸‹ï¼Œå¤§å®¶è‡ªä¸»çš„è®©å‡ºcpuæ—¶é—´ç‰‡ä¼šæ›´é«˜æ•ˆã€‚ä½ å¯èƒ½ä¼šæœ‰ä¸€ä¸¢ä¸¢ç–‘é—®ï¼Œé‚£å‡ ä¸ªå‘˜å·¥éƒ½æƒ³è¦åŒä¸€ä¸ªæ—¶é—´å‘¢ï¼Ÿè®©å‡ºè¿˜æœ‰æ„ä¹‰å—ï¼Ÿæœ‰çš„ï¼Œå› ä¸ºä¸äº’ç›¸åè°ƒæ—¶é—´çš„è¯ï¼Œé‚£å°±æœ€å·®çš„æƒ…å†µå°±æ˜¯ï¼šå¤§å®¶éƒ½è¢«å®‰æ’åœ¨è‡ªå·±å¿™çš„æ—¶é—´ï¼ˆioï¼‰ï¼Œä½†å¦‚æœåè°ƒå¥½æ—¶é—´çš„è¯ï¼Œå°±å¯ä»¥å‡å°‘è¿™ç§æƒ…å†µã€‚è¿™ç§å°±æ˜¯ioå¯†é›†å‹çš„åœºæ™¯ï¼Œé‡‡ç”¨åä½œçš„æ–¹å¼èƒ½å¤§å¤§å‡å°‘æ—¶é—´çš„æµªè´¹ã€‚

å¤§å®¶ä¸»åŠ¨è®©å‡ºçš„è¿™ç§è¡Œä¸ºå°±æ˜¯åä½œï¼Œè€Œä¸æ˜¯åƒä¸€å¼€å§‹é‚£æ ·çš„éƒ½å»æŠ¢å æ—¶é—´ç‰‡ã€‚è¿™é‡Œçš„è®©å‡ºï¼Œå…¶å®å°±æ˜¯æŒ‚èµ·çš„æ„æ€ï¼Œè€ŒæŒ‚èµ·å°±æ„å‘³ç€æŸä¸ªæ—¶é—´åè¿˜æ˜¯è¦æ¢å¤çš„ï¼Œè¿™é‡Œå’Œçº¿ç¨‹çš„çŠ¶æ€åˆ‡æ¢å¾ˆåƒï¼Œä½†åˆä¸ä¸€å®šæ˜¯çœŸæ­£çš„åˆ‡æ¢çº¿ç¨‹ï¼Œä¸‹æ–‡ä¼šè¯¦ç»†è®²ã€‚

ä»ä¸Šé¢çš„æ•…äº‹ä¸­å¯ä»¥çŸ¥é“ï¼šä»å¼ ä¸‰åˆ°æå››çš„ä¼šè®®å®‰æ’ï¼Œæ˜¯ç”±ä½ çš„ç§˜ä¹¦å†³å®šçš„ï¼Œè€Œä¸»åŠ¨è®©å‡ºå’Œä»€ä¹ˆæ—¶å€™å¼€ä¼šï¼Œæ˜¯ç”±å‘˜å·¥å†³å®šçš„ï¼Œè¿™é‡Œçš„å·®åˆ«å¾ˆå¤§ã€‚åœ¨ç¬¬äºŒç§æ–¹å¼ä¸‹ï¼Œä½ çš„ç§˜ä¹¦å¯ä»¥çœå»å¾ˆå¤šæ‰¾å‘˜å·¥æ²Ÿé€šçš„æ—¶é—´ã€‚

è€Œå¦‚æœå¼ ä¸‰æå››çš„å·¥ä½œå°±æ˜¯è´Ÿè´£å’Œä½ å¼€ä¼šï¼Œä¸éœ€è¦å†™ä»£ç ï¼Œä¸éœ€è¦ç”»ç¨¿å­ï¼Œä¸éœ€è¦ç”»åŸå‹ï¼Œé‚£è®©å¼ ä¸‰æå››ä¸Šçº¿ä¸‹çº¿ä¼šè®®çš„è¡Œä¸ºåè€Œä¼šå½±å“å¼ ä¸‰å’Œæå››çš„å·¥ä½œæ•ˆç‡ï¼Œè¿™ç§å°±æ˜¯è®¡ç®—å¯†é›†å‹çš„æƒ…å†µï¼Œä¸²è¡Œæ¯”å¹¶è¡Œé«˜æ•ˆã€‚ä½†å…¶å®æœ‰æ„æ€çš„æ˜¯ï¼Œæœ‰äº›è¯­è¨€çš„åç¨‹çš„è°ƒåº¦æœºåˆ¶åšçš„ä¸é”™ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸ä¼šé¢‘ç¹çš„åˆ‡æ¢ä¸Šä¸‹æ–‡ã€‚

# åç¨‹çš„å®ç°å·®å¼‚

æŸå¤©åˆä½œä¼™ä¼´å­™æ€»è¿‡æ¥ä½ è¿™å‚è§‚ï¼Œå‘ç°ä½ ç®¡ç†å‘˜å·¥çš„æ–¹æ³•ç‰¹åˆ«å¥½ï¼Œå›å»åé©¬ä¸Šå°è¯•æä¸€å¥—ã€‚ä¹Ÿè¯·äº†ä¸€ä¸ªç§˜ä¹¦ï¼Œå¸‚åœºä¸Šå¾ˆå¤šè¿™ç§ç®¡ç†ä¸“ä¸šçš„äººæ‰ï¼Œè¿™äº›äººæ‰çš„åŸ¹å…»æ—©æœ‰ä½“ç³»ï¼Œæ‰¾ä¸€ä¸ªå¾ˆç®€å•ï¼Œæ‰€ä»¥å­™æ€»çš„å…¬å¸å¾ˆå¿«å°±å®ç°äº†é€šè¿‡ç§˜ä¹¦å®‰æ’ä¼šè®®ã€‚è¿™é‡Œæ˜¯åœ¨è¯´ä¸åŒæ“ä½œç³»ç»Ÿçº¿ç¨‹çš„apiè®¾è®¡å¤§è‡´ç›¸åŒã€‚

ä½†ä»–é‡åˆ°äº†ä¸ªé—®é¢˜ï¼šä»–å‘ç°ä»–çš„å‘˜å·¥çš„ååŒèƒ½åŠ›æ¯”è¾ƒå·®ï¼ˆä¹Ÿå¯èƒ½ä»–å‘ç°ä»–å‘˜å·¥çš„ååŒèƒ½åŠ›å¾ˆå¼ºï¼Œç„¶åå‘ä½ å¾—æ„æ´‹æ´‹çš„ç‚«è€€ï¼‰ã€‚å‘˜å·¥çš„å²—ä½ï¼Œæ‰€æŒæ¡çš„æŠ€èƒ½ï¼Œæ€§æ ¼ï¼Œç´ è´¨æ°´å¹³ç­‰æ–¹é¢çš„ä¸åŒï¼Œä¸ç»è¿‡åŸ¹è®­ï¼Œå¾ˆéš¾ä¸€ä¸‹å­è¦æ±‚æ‰€æœ‰äººåšåˆ°å¾ˆå¥½çš„ååŒï¼ŒåŸ¹è®­çš„æ–¹å¼å’Œæ•ˆæœä¹Ÿä¸ä¸€æ ·ã€‚æ‰€ä»¥æœ‰çš„å…¬å¸å¯èƒ½æœ€ç»ˆåä½œçš„æ–¹æ¡ˆæ˜¯Aï¼Œæœ‰çš„å…¬å¸ååŒæ–¹æ¡ˆæ˜¯Bã€‚è¿™é‡Œå…¶å®æ˜¯åœ¨è¡¨è¾¾ï¼Œåç¨‹æ˜¯è¯­è¨€å±‚é¢ä¸Šçš„ä¸œè¥¿ï¼Œæ¯ç§è¯­è¨€çš„å®ç°æ–¹å¼éƒ½ä¸ä¸€æ ·ï¼Œæ•ˆæœä¹Ÿä¸ä¸€æ ·ã€‚

# å°ç»“

ä¸Šæ–‡æ˜¯ä»ç”Ÿæ´»çš„è§’åº¦å»å†™çš„ï¼Œä¾‹å­å¯èƒ½ä¸é‚£ä¹ˆçš„æ°å½“ï¼Œä½†è‡³å°‘æˆ‘ä»¬çŸ¥é“è¿›ç¨‹ä¸ºäº†åˆç†åˆ©ç”¨èµ„æºï¼Œåšäº†åŠªåŠ›ï¼Œä½†æ˜¯è¿˜æœ‰æå‡çš„ç©ºé—´ã€‚æ‰€ä»¥çº¿ç¨‹å‡ºç°äº†ï¼Œçº¿ç¨‹ä¹Ÿåšäº†åŠªåŠ›ï¼Œä½†è¿˜æ˜¯æœ‰æå‡ç©ºé—´ã€‚è¿™æ—¶å€™åç¨‹å‡ºç°äº†ï¼Œä¹Ÿåšäº†åŠªåŠ›ï¼Œè‡³äºæå‡ç©ºé—´ï¼ŒæŠ±æ­‰ï¼Œæˆ‘è¿˜å¤„äºçƒ­æ‹æœŸï¼Œçœ¼é‡Œéƒ½æ˜¯åç¨‹çš„å¥½ã€‚

åç¨‹ä¹Ÿåˆ†æœ‰æ ˆåç¨‹å’Œæ— æ ˆåç¨‹ã€‚å¸¸è¯´è°ƒç”¨æ ˆè°ƒç”¨æ ˆï¼Œè¿™é‡Œçš„æœ‰æ ˆå…¶å®å°±æ˜¯å› ä¸ºä¸€äº›åç¨‹é—´å¯èƒ½æœ‰è°ƒç”¨å…³ç³»ï¼Œæœ‰ä¸ªå¤§ä½¬è®²çš„å¾ˆå¥½ï¼š[æœ‰æ ˆåç¨‹å’Œæ— æ ˆåç¨‹](https://blog.csdn.net/weixin_43705457/article/details/106924435)

æˆ‘æ˜¯ä¸€åAndroidåº”ç”¨å¼€å‘è€…ï¼Œè€Œkotlinä¸­çš„åç¨‹æ˜¯æ— æ ˆåç¨‹ï¼Œæ‰€ä»¥ä¸‹æ–‡æ˜¯æˆ‘å¯¹äºkotlinæ— æ ˆåç¨‹çš„ç†è§£ã€‚ä¸‹æ–‡çš„è§’åº¦å¯èƒ½å’Œä¸Šæ–‡ä¸å¤ªä¸€æ ·ï¼Œç”Ÿæ´»ä¸­çš„ä¾‹å­è½å®åˆ°ä»£ç å®ç°ï¼Œæœ¬å°±æœ‰å·®è·ï¼Œæ‰€ä»¥è¯´å¤§éƒ¨åˆ†æ™®é€šäººä¸€ä¸‹å­éš¾ä»¥ç†è§£ç¨‹åºå¼€å‘ï¼Œæ˜¯å› ä¸ºæ²¡æœ‰ç¼–ç¨‹æ€ç»´å˜›ã€‚

è¦æƒ³äº†è§£åç¨‹ï¼Œå°±å¿…é¡»äº†è§£é—­åŒ…çš„æ¦‚å¿µï¼Œå½“ç„¶æˆ‘ä»¬å¯ä»¥ä»æœ€ç†Ÿæ‚‰çš„å›è°ƒå…¥æ‰‹ã€‚

# é­”æ³•ï¼šå›è°ƒå‡½æ•°

![image](https://github.com/BAByte/pic/blob/master/%E4%B8%8B%E8%BD%BD21%E4%BA%BA%E6%83%85%E6%81%B63341.jpeg?raw=true)

åœ¨ç¬¬ä¸€æ¬¡æ¥è§¦å›è°ƒå‡½æ•°çš„æ—¶å€™ï¼Œæˆ‘ç›¸ä¿¡å¾ˆå¤šäººéƒ½ä¼šè§‰å¾—è¿™æ˜¯ä¸ªç‰¹åˆ«çš„ä¸œè¥¿ã€‚å®ƒçœŸçš„å¾ˆçµæ´»ï¼Œå¾ˆç¥å¥‡ï¼æˆ‘ä»¬çœ‹çœ‹ï¼š

æˆ‘ä»¬å¸¸åœ¨ä¸€ä¸ªå‡½æ•°ä¸­è°ƒç”¨é€šè¿‡å‚æ•°ä¼ å…¥çš„å¯¹è±¡ï¼Œè¿›è€Œä½¿ç”¨è¿™ä¸ªå¯¹è±¡çš„å‡½æ•°å»åšæŸäº‹ï¼š

~~~kotlin
class LogPrinter {
  fun print() {
    ...
  }
}

fun printLog(logPrinter:LogPrinter) {
  logPrinter.print();
}
~~~

ä½†ä½ éœ€è¦æå‰ç”¨ç±»å»æè¿°è¿™ä¸ªè¡Œä¸ºã€‚ä½†æ˜¯æˆ‘ä»¬çŸ¥é“ç±»æ‰€èƒ½æè¿°çš„ä¸ä»…ä»…æ˜¯ä¸€ä¸ªè¡Œä¸ºï¼

åŒæ—¶åœ¨äº‹ä»¶é©±åŠ¨å‹çš„è®¾è®¡ä¸­ï¼Œä¼šæœ‰çº¿ç¨‹åœ¨ä¸æ–­çš„ç­‰å¾…äº‹ä»¶å’Œæ¶ˆè´¹äº‹ä»¶ï¼Œå°±æ˜¯å¹¶å‘ä¸­çš„â€œç”Ÿäº§è€…æ¶ˆè´¹è€…â€æ¨¡å‹ï¼Œå‡è®¾åªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œåœ¨ä¸€äº›ç¨‹åºä¸­å¯èƒ½ç§°ä¹‹ä¸ºä¸»çº¿ç¨‹ï¼Œé‚£ä¸»çº¿ç¨‹å³æ˜¯ç”Ÿäº§è€…ï¼ˆå­˜åœ¨è‡ªå·±ç»™è‡ªå·±å‘äº‹ä»¶çš„æƒ…å†µï¼‰ï¼Œä¹Ÿæ˜¯æ¶ˆè´¹è€…ã€‚å½“ç„¶ï¼Œå¤§å¤šç”Ÿäº§è€…æ˜¯å…¶ä»–çº¿ç¨‹ï¼š

![image](https://github.com/BAByte/pic/blob/master/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_ea9dd769-073d-4fb7-b36b-e9caad578886.png?raw=true)

è€Œäº‹ä»¶çš„è¡Œä¸ºå’Œè§„åˆ™å¹¶ä¸æ˜¯å›ºå®šçš„ï¼Œå¦‚æœç”¨ç±»å»æå‰æè¿°ä¸€ä¸ªè¡Œä¸ºï¼Œæ˜¯ä¸æ˜¯æœ‰ç‚¹å¤§æå°ç”¨äº†ï¼Ÿæ˜¯ä¸æ˜¯è¦æå‰å£°æ˜ä¸€å †ç±»ï¼Ÿé‚£æœ‰æ²¡æœ‰ä¸€ç§ä¸œè¥¿å¯ä»¥åªé’ˆå¯¹è¡Œä¸ºçš„ä¸œè¥¿ï¼ŒçœŸæ­£è¦ç”¨çš„æ—¶å€™å†å®šä¹‰ï¼Ÿ

æœ‰å•Šï¼Œé‚£ä¸å°±æ˜¯å‡½æ•°å—ï¼Ÿè¿™é‡Œå°±ä½“ç°å‡ºäº†å›è°ƒå‡½æ•°çš„çµæ´»ä¹‹å¤„ã€‚

å†…éƒ¨ç±»æˆ‘è§è¿‡ï¼Œåœ¨å‡½æ•°é‡Œé¢å£°æ˜å’Œå®ç°å‡½æ•°æ˜¯ä»€ä¹ˆé¬¼ï¼Ÿå°±æ˜¯é—­åŒ…å˜›ï¼

javaæ”¯æŒä»¥å‚æ•°å½¢å¼ä¼ é€’å‡½æ•°å—ï¼Ÿä¸€ç›´éƒ½æ”¯æŒï¼Œåªæ˜¯java8æ¯”è¾ƒæ˜æ˜¾ï¼

ä¼ é€’åçš„å‡½æ•°ä½¿ç”¨çš„thiså¯¹è±¡æ˜¯è°ï¼Ÿè¿™é‡Œè®²ä¸ªæ•…äº‹ä½ å°±æ˜ç™½äº†ï¼š

> å”åƒ§èµ¶èµ°äº†å­™çŒ´å­ï¼Œä½†å¤§åœ£è¿˜æ˜¯å®³æ€•å¸ˆå‚…å‡ºäº‹ï¼Œä¾¿æ‹”ä¸‹äº†ä¸‰æ ¹æ¯›äº¤ç»™äº†å…«æˆ’ï¼Œå‘ŠçŸ¥å…«æˆ’ä¸€å‡ºäº‹å°±å¹ä¸€æ ¹æ¯›ï¼Œä¿ºè€å­™è‡ªç„¶ä¼šå‡ºç°ã€‚

åŒæ—¶ä¸ºäº†ä¿è¯èƒ½æŒç»­æ¶ˆè´¹äº‹ä»¶ï¼Œä¸èƒ½åœ¨ä¸»çº¿ç¨‹ä¸­æœ‰è€—æ—¶çš„æ“ä½œï¼Œè€Œè€—æ—¶æ“ä½œå¸¸è§çš„éƒ½æ˜¯åœ¨è®¡ç®—æ•°æ®ï¼Œè·å–æ•°æ®ç­‰ï¼Œä¸»çº¿ç¨‹æ€ä¹ˆåšåˆ°ä¸ç­‰å¾…åˆèƒ½åœ¨åˆé€‚çš„æ—¶é—´æ‹¿åˆ°ç»“æœè¿›è¡Œå¤„ç†ï¼Ÿ

ä¸€ä¸ªå›è°ƒå‡½æ•°èƒ½è§£å†³ä¸Šé¢çš„ç§ç§é—®é¢˜ï¼Œç¥å¥‡å§ï¼ä¸ºä»€ä¹ˆè¿™ä¹ˆç¥å¥‡ï¼Ÿ

æ˜¯çš„ï¼Œé€¼é€¼äº†è¿™ä¹ˆå¤šå°±æ˜¯æƒ³çœ‹çœ‹ä½ æ˜¯å¦äº†è§£é—­åŒ…ï¼Œå¦‚æœä¸äº†è§£ï¼Œä¸‹é¢å¯èƒ½ä¼šçœ‹çš„äº‘é‡Œé›¾é‡Œï¼Œä½†æ˜¯å¦‚æœä½ éƒ½æ‡‚ï¼Œæ­å–œä½ ï¼Œä¸‹é¢çš„å†…å®¹å¯¹ä½ è€Œè¨€æå…¶ç®€å•ï¼

ä¸äº†è§£çš„è¯ï¼Œå…ˆå»æŸ¥æŸ¥ï¼Œé«˜é˜¶å‡½æ•°ã€é—­åŒ…ã€javaçš„åŒ¿åå†…éƒ¨ç±»å§ï¼

# å›è°ƒé­”æ³•çš„ç‰¹åˆ«ä¹‹å¤„

æˆ‘è¿™é‡Œå°†ä»å¤§å®¶éƒ½å¤´ç–¼çš„çº¿ç¨‹åŒæ­¥ï¼Œä»å®é™…ä¾‹å­å»è®²é—­åŒ…çš„ç¥å¥‡ç‰¹æ€§åœ¨åç¨‹ä¸­çš„åº”ç”¨ï¼Œæ¥èŠèŠå›è°ƒé­”æ³•çš„å¼ºå¤§ä¹‹å¤„ã€‚

æœ‰è¿™æ ·çš„ä¸€ä¸ªåœºæ™¯ï¼šåŠ è½½ç½‘é¡µèµ„æºå¹¶ç»˜åˆ¶ã€‚ç”±äºåŠ è½½ç½‘é¡µæ˜¯ä¸ªè€—æ—¶çš„ioæ“ä½œï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šå°†è¯¥è€—æ—¶æ“ä½œç»™å¦ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image](https://github.com/BAByte/pic/blob/master/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_18e23b19-e1eb-42fd-9483-b158e0229653.png?raw=true)

ä¸»çº¿ç¨‹éœ€è¦resourceå»ç»˜åˆ¶æ˜¾ç¤ºï¼Œæ‰€ä»¥åªèƒ½ç­‰å¾…çº¿ç¨‹Bæ‰§è¡Œå®Œæˆï¼Œå¦åˆ™ä¸»çº¿ç¨‹å°†æ²¡æœ‰å†…å®¹å¯ä»¥paintã€‚è™½ç„¶ä¸»çº¿ç¨‹æ²¡æœ‰æ‰§è¡Œè€—æ—¶æ“ä½œï¼Œä½†æ˜¯ä¸»çº¿ç¨‹ä¼šé˜»å¡å¹¶ç­‰å¾…çº¿ç¨‹Bå”¤é†’è‡ªå·±ï¼Œè¿™æ˜¯å¾ˆç®€å•çš„çº¿ç¨‹åŒæ­¥æ“ä½œã€‚

è‰ºæœ¯æºäºç”Ÿæ´»ï¼Œæˆ‘ä»¬çš„æ—¥å¸¸ç”Ÿæ´»ä¸­ä¹Ÿä¼šæœ‰è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬çš„è§£å†³åŠæ³•å°±æ˜¯ï¼šæå®šäº†é€šçŸ¥æˆ‘ã€‚æ‰€ä»¥ä¸»çº¿ç¨‹åº”è¯¥åœ¨çº¿ç¨‹Bé€šçŸ¥è‡ªå·±åŠ è½½èµ„æºå®Œæˆåï¼Œæ‰å»paintã€‚

ä½†æˆ‘ä»¬é€šå¸¸åœ¨è¿™ä¸ªæœŸé—´ä¼šå»åšå…¶ä»–çš„äº‹æƒ…è€Œä¸æ˜¯ç­‰å¾…ï¼Œæ‰€ä»¥æˆ‘ä»¬å¸Œæœ›ä¸»çº¿ç¨‹å»ç»§ç»­æ¶ˆè´¹å…¶ä»–äº‹ä»¶ï¼Œè€Œä¸æ˜¯åœ¨é˜»å¡ã€‚

è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å›è°ƒå®ç°éé˜»å¡çš„é€šçŸ¥ã€‚

![image](https://github.com/BAByte/pic/blob/master/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_e3ee3018-8040-4e7a-be41-44610022248f.png?raw=true)

æˆ‘ä»¬ä¼ å…¥çš„å‡½æ•°å›è°ƒï¼Œå¹¶æ²¡æœ‰å®ç°çº¿ç¨‹åˆ‡æ¢çš„åŠŸèƒ½ï¼Œä½ æš‚ä¸”è®¤ä¸ºè¿™é‡Œæ˜¯çº¿ç¨‹Bå†…éƒ¨åœ¨invokeè¿™ä¸ªå›è°ƒæ—¶åšäº†çº¿ç¨‹åˆ‡æ¢ï¼Œä¹Ÿå°±æ˜¯å°†è¯¥å›è°ƒåŒ…è£…åæ”¾åˆ°é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…ä¸»çº¿ç¨‹æ¶ˆè´¹ï¼Œåé¢ä¼šè¯¦ç»†è®²çº¿ç¨‹åˆ‡æ¢ã€‚loadResourceæ–¹æ³•ç±»ä¼¼è¿™ä¸ªæ ·å­ï¼š

~~~kotlin
fun loadResource(callBack:(Resource) ->Unit) {
  thread {
    val result = load() //è€—æ—¶
    //åŒ…è£…ä¸€ä¸‹ï¼Œå‘é€ç»™ä¸»çº¿ç¨‹ï¼Œè®©ä¸»çº¿ç¨‹æ‰§è¡ŒcallBack.invoke()
    sendToMainThread(){
      callBack.invoke(result)
    }
  }
}
~~~

è¿™æ®µä»£ç åšåˆ°äº†ï¼šâ€œåšå®Œé€šçŸ¥æˆ‘â€ï¼Œå¹¶ä¸”ä¸»çº¿ç¨‹å¹¶æ²¡æœ‰è¢«é˜»å¡ï¼ä¹Ÿæ²¡æœ‰å› ä¸ºæ‰§è¡Œè¿™æ®µä»£ç å‘ç”Ÿçº¿ç¨‹çŠ¶æ€çš„å˜åŒ–ï¼è¿™é‡Œå°±èƒ½çœä¸‹çº¿ç¨‹çŠ¶æ€åˆ‡æ¢å¸¦æ¥çš„å¼€é”€ã€‚

# å°ç»“

ä»”ç»†ç¢ç£¨æ‰§è¡Œé¡ºåºå°±èƒ½å‘ç°ç‰¹åˆ«ä¹‹å¤„ï¼š

**åœ¨æ²¡æœ‰å›è°ƒçš„ä»£ç ä¸­ï¼Œä¸»çº¿ç¨‹çš„ä»£ç æ‰§è¡Œé¡ºåºæ˜¯ï¼š**

1. è¿›å…¥showHtmlPageæ–¹æ³•
2. è®©çº¿ç¨‹Bæ‰§è¡ŒloadResourceæ–¹æ³•
3. è¿›å…¥ç¡çœ 
4. é‡æ–°å”¤é†’ï¼Œè¿›è¡Œç»˜åˆ¶
5. é€€å‡ºshowHtmlPageæ–¹æ³•
6. æ¶ˆè´¹å…¶ä»–äº‹ä»¶

**æœ‰å›è°ƒçš„ä»£ç ä¸­ï¼šä¸»çº¿ç¨‹çš„æ‰§è¡Œé¡ºåºæ˜¯**

1. è¿›å…¥showHtmlPageæ–¹æ³•
2. è®©çº¿ç¨‹Bæ‰§è¡ŒloadResourceæ–¹æ³•
3. é€€å‡ºshowHtmlPageæ–¹æ³•
4. æ¶ˆè´¹å…¶ä»–äº‹ä»¶
5. çº¿ç¨‹Bé€šçŸ¥æ‰§è¡Œç»˜åˆ¶

æ³¨æ„ï¼åœ¨ä¸Šé¢è¿™ç§æƒ…å†µä¸­çš„showHtmlPageå‡½æ•°å†…éƒ¨æ•´ä½“é¡ºåºæ˜¯ä¸å˜çš„ï¼Œé¡ºåºå¿…ç„¶æ˜¯ï¼š

1. è¿›å…¥showHtmlPageæ–¹æ³•
2. æ‰§è¡ŒloadResourceæ–¹æ³•
3. æ‰§è¡Œç»˜åˆ¶

ä½†å›è°ƒè¿™ä¸ªä»£ç å—ç›¸å¯¹äºé˜Ÿåˆ—ä¸­çš„å…¶ä»–äº‹ä»¶è€Œè¨€ï¼ˆäº‹ä»¶å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªä¸ªä»£ç å—ï¼‰ï¼Œæ‰§è¡Œé¡ºåºå‘ç”Ÿäº†å˜åŒ–ã€‚æ‰€ä»¥ä½ è¦æ˜¯è§‰å¾—åç¨‹å°±æ˜¯ä¸€ä¸ªä¸ªå¾…æ‰§è¡Œçš„ä»£ç å—ï¼Œå¯¹çš„ï¼ä½ æ‘¸åˆ°é—¨é“äº†ï¼**å°†è¦æ‰§è¡Œçš„ä»£ç ä½¿ç”¨å›è°ƒ â€åŒ…è£…èµ·æ¥â€œï¼Œæ˜¯æ— æ ˆåç¨‹å®ç°æ‰§è¡ŒçŠ¶æ€æµè½¬çš„é‡è¦å‰æä¹‹ä¸€ï¼è€Œå›è°ƒèƒ½åœ¨åˆé€‚çš„æ—¶æœºæ‰§è¡Œï¼è¿™æ˜¯çº¿ç¨‹ä½¿å¾—è¢«åŒ…è£…çš„ä»£ç å—ä¹‹é—´æ‰§è¡Œé¡ºåºå‘é€å˜åŒ–çš„æœ€å¥½ä½“ç°ï¼**

# é­”æ³•è¿›é˜¶

æˆ‘ä»¬å†çœ‹è¿™æ ·çš„ä¸€ä¸ªä¾‹å­ï¼š

éœ€è¦ä»ä¸åŒçš„åœ°å€è·å–èµ„æºï¼Œä¹Ÿæ˜¯å…ˆç”¨æœ€ç®€å•çš„åŒæ­¥æ–¹æ³•å»å®ç°ï¼šï¼ˆå›¾ä¸­çš„UIThreadå°±æ˜¯ä¸Šæ–‡è¯´çš„ä¸»çº¿ç¨‹ï¼Œæˆ‘ç”»å›¾ä¸€æ—¶æ‡µé€¼ï¼Œå†™é”™äº†ï¼‰

![image](https://github.com/BAByte/pic/blob/master/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_60e2e2cd-c5d3-41c5-a9a1-b6797955f16c.png?raw=true)

é—®é¢˜ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œä¸»çº¿ç¨‹ä¹Ÿè¢«é˜»å¡ä¸¤æ¬¡ï¼Œä¸¤æ¬¡çº¿ç¨‹åŒæ­¥é€ æˆäº†çº¿ç¨‹çš„çŠ¶æ€çš„åˆ‡æ¢ï¼Œå‡è®¾loadResourceAèŠ±10ç§’ï¼ŒloadResourceBèŠ±10ç§’ï¼Œé‚£ä»åŠ è½½å®Œåˆ°ç»˜åˆ¶ï¼Œæ€»å…±çš„æ—¶é—´ï¼Œæ¨¡ç³Šä¼°è®¡èŠ±äº†20.10Sï¼Œæˆ‘åˆæ¬å‡ºäº†å›è°ƒå¤§æ³•ï¼š

**æ³¨æ„ï¼šï¼ˆè¿™é‡Œçš„çº¿ç¨‹çŠ¶æ€åˆ‡æ¢è€—è´¹çš„æ—¶é—´ä¸º0.1sï¼Œåªæ˜¯ä¸ºäº†å¥½ç†è§£çç¼–çš„ï¼Œå¦‚æœä½ å¾ˆæƒ³çŸ¥é“çº¿ç¨‹åˆ‡æ¢çš„æ—¶é—´ï¼Œå¯ä»¥è°·æ­Œä¸€ä¸‹ï¼‰**

~~~kotlin
    fun showHtmlPage() {
        val addrA = "A"
        val addrB = "B"

        loadResource(addrA) { resourceA ->
            loadResource(addrB) { resourceB ->
                paint(resourceFromA, resource)
            }
        }
    }
~~~

è§£å†³äº†é˜»å¡é—®é¢˜ï¼Œä¸»çº¿ç¨‹æœ‰æ—¶é—´å»åšå…¶ä»–äº‹æƒ…ï¼Œä¸ºäº†æ›´å¥½ç†è§£æˆ‘ä»¬å‡è®¾å…¶ä»–ä»£ç æ‰§è¡Œï¼Œæˆ‘è¿™é‡Œå‡è®¾cpuç­‰è°ƒåº¦éƒ½ä¸èŠ±æ—¶é—´ï¼Œä½†ä»£ç å—ä»åŠ è½½å®Œåˆ°ç»˜åˆ¶æ€»å…±çš„æ—¶é—´ä¹ŸèŠ±äº†20Sï¼Œç¼©çŸ­çš„éƒ½æ˜¯åœ¨çº¿ç¨‹åˆ‡æ¢è¿‡ç¨‹ä¸­çš„æ—¶é—´ï¼Œé‚£ä¹Ÿæ²¡ç¼©çŸ­å¤šå°‘ç§’ã€‚å› ä¸ºåŠ è½½èµ„æºå…¶å®æˆ‘ä»¬è¿˜æ˜¯ä¸²è¡Œçš„ã€‚

è¿™æ—¶å€™æˆ‘ä»¬ç»§ç»­åˆ©ç”¨å¹¶å‘å’Œå›è°ƒå»åˆç†åˆ©ç”¨èµ„æºï¼š

**æ³¨æ„ï¼šï¼ˆè¿™é‡Œçš„çº¿ç¨‹çŠ¶æ€åˆ‡æ¢è€—è´¹çš„æ—¶é—´ä¸º0.1sï¼Œåªæ˜¯ä¸ºäº†å¥½ç†è§£çç¼–çš„ï¼Œå¦‚æœä½ å¾ˆæƒ³çŸ¥é“çº¿ç¨‹åˆ‡æ¢çš„æ—¶é—´ï¼Œå¯ä»¥è°·æ­Œä¸€ä¸‹ï¼‰**

~~~kotlin
    fun showHtmlPage() {
        val addrA = "A"
        val addrB = "B"
        var resourceFromA:Resource
        var resourceFromB:Resource

        loadResource(addrA) {resource ->
            if (resourceFromB!=null) {
                paint(resource,resourceFromB)
            }else {
                resourceFromA = resource
            }
        }
        loadResource(addrB) {resource ->
            if (resourceFromA!=null) {
                paint(resourceFromA,resource)
            }else {
                resourceFromB = resource
            }
        }
    }
~~~

æˆ‘æŠŠä¸¤ä¸ªåŠ è½½æ•°æ®å˜æˆäº†å¹¶è¡Œï¼Œè¿™æ—¶åŠ è½½å®Œåˆ°ç»˜åˆ¶æ€»å…±çš„æ—¶é—´ï¼Œæ¨¡ç³Šä¼°è®¡ä¹ŸèŠ±äº†10Sï¼Œè¿™é‡Œç¼©çŸ­çš„å°±æ˜¯ä¸²è¡Œçš„æ—¶æœºï¼Œå› ä¸ºä¸¤ä¸ªèµ„æºçš„åŠ è½½æ˜¯åŒæ—¶åœ¨è¿›è¡Œçš„ã€‚

è¿™æ—¶å€™ä½ ä¼šåœ¨æƒ³ï¼šä½ ä¸¤ä¸ªå›è°ƒæ˜¯å¦ä¼šæœ‰èµ„æºç«äº‰é—®é¢˜ï¼Ÿæ²¡æœ‰ï¼å‰é¢å·²ç»è¯´äº†loadResourceæ–¹æ³•å†…éƒ¨åšäº†çº¿ç¨‹åˆ‡æ¢æ“ä½œï¼ï¼ï¼ï¼

ä½†ä¸ºäº†æ›´å¥½çš„çš„ç†è§£ä¸ºä»€ä¹ˆè¦åšçº¿ç¨‹åˆ‡æ¢ï¼Œæˆ‘ä»¬å…ˆå‡è®¾å­˜åœ¨èµ„æºç«äº‰ï¼šä¹Ÿå°±æ˜¯å›è°ƒéƒ½æ˜¯ç”±ä¸åŒçš„çº¿ç¨‹å»invokeçš„ï¼Œé‚£ä½ åªèƒ½åŠ é”ï¼šï¼ˆæˆ‘å°±ç®€å•ç²—æš´çš„åŠ é”äº†ï¼Œæ˜¯å¦é”å¯¹äº†ï¼Œä¸è¦å¤ªçº ç»“ï¼‰

~~~kotlin
    fun showHtmlPage() {
        val addrA = "A"
        val addrB = "B"
        var resourceFromA:Resource
        var resourceFromB:Resource

        loadResource(addrA) {resource ->
           synchronizedï¼ˆobjï¼‰{
                if (resourceFromB!=null) {
                    paint(resource,resourceFromB)
                }else {
                    resourceFromA = resource
                }
           }             
        }
        loadResource(addrB) {resource ->
          synchronizedï¼ˆobjï¼‰{
               if (resourceFromA!=null) {
                   paint(resourceFromA,resource)
               }else {
                   resourceFromB = resource
               }
           }
        }
    }
~~~

åŠ äº†é”åï¼ŒåŠ è½½å®Œåˆ°ç»˜åˆ¶æ€»å…±çš„æ—¶é—´ï¼Œå¤§èƒ†ä¸€èŠ±äº†11.2sï¼Œåšäº†è¿™é›¶ç‚¹å‡ ç§’åŸå› å°±æ˜¯åŠ é”ï¼Œsynchronizedæ˜¯äº’æ–¥é”ï¼Œä¼šé˜»å¡å…¶ä»–çš„çº¿ç¨‹ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸ºäº†è§£å†³ä¸€ä¸ªé—®é¢˜ï¼Œå¼•å…¥äº†ä¸€ä¸ªæ–°é—®é¢˜ã€‚

æˆ‘åšçº¿ç¨‹åˆ‡æ¢çš„åŸå› ï¼šè¿™ä¸ªloadResourceæ–¹æ³•ä¸­å†…éƒ¨å°±åšäº†çº¿ç¨‹åˆ‡æ¢ï¼Œè¿™ä¸¤ä¸ªå›è°ƒä¸€å®šæ˜¯åœ¨ä¸»çº¿ç¨‹ä¸²è¡Œçš„ï¼Œä¸å­˜åœ¨å¤šçº¿ç¨‹åŒæ—¶æ“ä½œresourceFromAã€resourceFromBçš„æƒ…å†µã€‚

# å°ç»“

**è¿™ç‚¹ä¹Ÿå¾ˆæœ‰æ„æ€å¯¹å§ï¼è¿™ä¹Ÿæ˜¯åˆ©ç”¨åç¨‹è§£å†³èµ„æºç«äº‰çš„ä¸€ä¸ªæ€æƒ³ï¼šé€šè¿‡è°ƒæ•´å›è°ƒä»£ç å—çš„æ‰§è¡Œç¯å¢ƒï¼Œå°†æ›´æ”¹å…¬å…±èµ„æºçš„ä»£ç å—æµè½¬åˆ°ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œï¼Œè¿›è€Œè§£å†³å¤šçº¿ç¨‹èµ„æºç«äº‰çš„é—®é¢˜ã€‚**

ä½†åœ¨loadResourceæ–¹æ³•å†…å®ç°çº¿ç¨‹åˆ‡æ¢æ˜¾ç„¶æ˜¯ä¸å¥½çš„è®¾è®¡ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è®¾è®¡ä¸€ä¸ªè°ƒåº¦å™¨ï¼Œå»æŒ‡å®šå›è°ƒåœ¨å“ªä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œæ˜¯ä¸æ˜¯åœ¨ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥è§£å†³å¤šçº¿ç¨‹å¹¶å‘çš„èµ„æºç«äº‰é—®é¢˜ï¼ŸåŒæ—¶ä¸Šæ–‡çš„ä»£ç ä¸­ï¼ŒåŠ è½½èµ„æºä¼šåˆå§‹åŒ–ä¸¤ä¸ªçº¿ç¨‹ï¼Œé‚£åŠ è½½100ä¸ªèµ„æºæ˜¯ä¸æ˜¯éœ€è¦100ä¸ªçº¿ç¨‹ï¼Ÿçº¿ç¨‹èµ„æºçš„åˆ›å»ºå’Œé‡Šæ”¾åˆæ˜¯ä¸€ä¸ªæ¶ˆè€—èµ„æºçš„æ“ä½œï¼Œè¿™ä¸ªåˆæ€ä¹ˆè§£å†³ï¼Ÿ

# è§£å†³èµ„æºç«äº‰

å¦‚æœå¼€å‘è€…åˆç†çš„åˆ©ç”¨è°ƒåº¦å™¨ï¼šæŒ‡å®šæ“ä½œå…¬å…±èµ„æºçš„å›è°ƒåœ¨åŒä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œè¿™æ ·å°±ä¸ä¼šæœ‰èµ„æºç«äº‰é—®é¢˜ã€‚é‚£å¯ä»¥è®©ç¨‹åºå‘˜åœ¨å†™çš„æ—¶å€™ï¼Œå°±æŒ‡å®šè¯¥ä»£ç æ®µï¼ˆå›è°ƒï¼‰ä¼šåœ¨å“ªä¸ªçº¿ç¨‹æ‰§è¡Œï¼š

~~~kotlin
    loadResource(UIThreadï¼ŒaddrB) { resourceB ->
                paint(resourceFromA, resource)
    }
~~~

æ‰€ä»¥è¿™ä¸ªè°ƒåº¦å™¨å¦‚æœé’ˆå¯¹çº¿ç¨‹ç¯å¢ƒå®ç°ï¼Œä¼šæ›´åŠ çµæ´»ã€‚é‚£æˆ‘ä»¬å¯ä»¥ç»™ä¸Šæ–‡çš„ä¸»çº¿ç¨‹å•ç‹¬è®¾è®¡ä¸€ä¸ªç¬¦åˆä¸‹å›¾æ¨¡å‹çš„è°ƒåº¦å™¨ï¼Œï¼š

![image](https://github.com/BAByte/pic/blob/master/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_ea9dd769-073d-4fb7-b36b-e9caad578886.png?raw=true)

# è§£å†³é¢‘ç¹åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹çš„æ€§èƒ½æ¶ˆè€—

æˆ‘ç›¸ä¿¡å¾ˆå¤šç¨‹åºå‘˜éƒ½çŸ¥é“æ€ä¹ˆè§£å†³é¢‘ç¹åˆ›å»ºå’Œé‡Šæ”¾çº¿ç¨‹çš„é—®é¢˜ï¼Œæ˜¯çš„æ²¡é”™ï¼Œå°±æ˜¯çº¿ç¨‹æ± ã€‚

æˆ‘åœ¨ä¸Šæ–‡æœ‰æåˆ°ï¼š

> å¦‚æœå¼ ä¸‰æå››çš„å·¥ä½œå°±æ˜¯è´Ÿè´£å’Œä½ å¼€ä¼šï¼Œä¸éœ€è¦å†™ä»£ç ï¼Œä¸éœ€è¦ç”»ç¨¿å­ï¼Œä¸éœ€è¦ç”»åŸå‹ï¼Œé‚£è®©å¼ ä¸‰æå››ä¸Šçº¿ä¸‹çº¿ä¼šè®®çš„è¡Œä¸ºåè€Œä¼šå½±å“å¼ ä¸‰å’Œæå››çš„å·¥ä½œæ•ˆç‡

æ˜¯å¦å¯ä»¥æ ¹æ®ioå¯†é›†å‹æˆ–è¿ç®—å¯†é›†å‹ï¼Œé€‰æ‹©ä¸åŒçš„è°ƒåº¦å™¨ï¼Ÿå› ä¸ºåªæœ‰å¼€å‘äººå‘˜çŸ¥é“æ˜¯å“ªç§ç±»å‹ã€‚

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ï¼š

> é’ˆå¯¹è¿ç®—å‹çš„è°ƒåº¦å™¨çš„çº¿ç¨‹æ± å¯ä»¥æ ¹æ®cpuæ ¸å¿ƒæ•°å»åˆ›å»ºçº¿ç¨‹æ•°é‡ã€‚
>
> é’ˆå¯¹ioå¯†é›†å‹çš„è°ƒåº¦å™¨çš„çº¿ç¨‹æ± å¯ä»¥åˆ›å»ºå¥½å¤šä¸ªçº¿ç¨‹ã€‚

é‚£è¿™å°±æœ‰ä¸‰ä¸ªåŸºæœ¬çš„è°ƒåº¦å™¨äº†ï¼ä½†åœ¨ä¸Šæ–‡æåˆ°loadResourceæ–¹æ³•ä¸­å†…éƒ¨å°±åšäº†çº¿ç¨‹åˆ‡æ¢ï¼Œå‡è®¾æœ‰å¾ˆå¤šç±»ä¼¼äºloadResourceçš„æ–¹æ³•ï¼Œä»–ä»¬æ˜¯ä¸æ˜¯ä¹Ÿè¦è‡ªå·±åšçº¿ç¨‹åˆ‡æ¢ï¼Ÿè¿™ä¸ç¬¦åˆå•ä¸€èŒè´£å¯¹å§ï¼Ÿ

# åˆ›é€ æ–°é­”æ³•ï¼Œè®©å›è°ƒå…·å¤‡çº¿ç¨‹åˆ‡æ¢èƒ½åŠ›

**æ³¨æ„ï¼ä»¥ä¸‹æ˜¯æˆ‘ä¸ºäº†å¥½ç†è§£æ€æƒ³ï¼Œç”¨javaå†™å‡ºæ¥çš„ä»£ç  ï¼Œkotlinå…·ä½“å®ç°åç¨‹çš„ä»£ç ä¸å®Œå…¨æ˜¯è¿™æ ·çš„ï¼**

ï¼ˆä¸ºä»€ä¹ˆæ˜¯javaï¼Ÿå› ä¸ºæˆ‘ç”¨kotlinå†™è¿™ä¸ªä¾‹å­æ„Ÿè§‰æ€ªæ€ªçš„ï¼‰

# å®šä¹‰é€šç”¨å›è°ƒæ¥å£

åœ¨javaä¸­çš„å›è°ƒæ˜¯åŒ¿åå†…éƒ¨ç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬å£°æ˜ä¸ªæ¥å£ï¼Œç”¨æ¥ç»™ä½¿ç”¨æ–¹å®ä¾‹åŒ–ï¼Œä½œä¸ºé€šç”¨å›è°ƒï¼Œè¿™ä¸ªå›è°ƒä¾›ç”¨æˆ·åŒ…è£…è‡ªå·±çš„è€—æ—¶åŒæ­¥ä»£ç ï¼Œæ‰€ä»¥éœ€è¦è¿”å›å€¼ã€‚

~~~java
public interface FakerCallBack {
    public Object invokeSuspend();
}
~~~

# ç»­ä½“ä¼ é€’é£æ ¼

å¼‚æ­¥æ‹¿ç»“æœï¼Œå¿…ç„¶æ˜¯é€šè¿‡å›è°ƒï¼Œè¿™é‡Œè¦æä¸€ä¸‹ä»€ä¹ˆå«ç»­ä½“ä¼ é€’é£æ ¼ï¼Œå…¶å®å°±æ˜¯é€šè¿‡å›è°ƒå°†ç»“æœä¼ é€’ç»™è°ƒç”¨æ–¹çš„æ„æ€ï¼Œä¸¾ä¸ªç®€å•ä¾‹å­ï¼š

ä¸€èˆ¬å†™æ³•ï¼š

~~~java
public String getWelcomeSpeech() {
  return "welcome";
}

public void sayWelcome() {
  System.out.println(getWelcomeSpeech());
}
~~~

ç»­ä½“ä¼ é€’é£æ ¼ï¼š

~~~java
interface FakerCompletionResult {
    public void resumeWith(Object value);
}


public void getWelcomeSpeech(FakerCompletionResult completion) {
  completion.resumeWith("welcome");
}

public void sayWelcome() {
  getWelcomeSpeech(value -> {
       System.out.println(value)    
  });
}
~~~



æ‰€ä»¥è¦å®šä¸€ä¸ªå¯ä»¥ä¼ é€’ç»“æœçš„å›è°ƒ

~~~java
public interface FakerContinuation {
    public void resumeWith(Object obj);
}
~~~

# Runnable -ã€‹ Job

æˆ‘ä»¬è¦åˆ‡æ¢åç¨‹ï¼Œçº¿ç¨‹è®¤å“ªä¸ªå›è°ƒï¼Ÿæ˜¯çš„ï¼ŒRunnableï¼Œä»–ä¹Ÿæ˜¯ä¸ªæ¥å£ï¼Œè¿™é‡Œä¸ºäº†åŒºåˆ†å¼€ï¼Œæˆ‘å®šä¹‰ä¸€ä¸ªJobï¼ˆä¸ç®—å¤šæ¬¡ä¸€ä¸¾å“ˆï¼Œå› ä¸ºè¿™é‡Œå°±æ˜¯è¦å’Œçº¿ç¨‹çš„åŒºåˆ†å¼€ï¼Œå†™ä¸€ä¸ªå¥½ç†è§£ï¼‰ï¼š

~~~java
public interface FakerJob {
    public void start();
}
~~~

# å›è°ƒæ‹¦æˆª

æˆ‘ä»¬ä¸Šé¢å®šä¹‰çš„å›è°ƒæ¥å£ä¸å…·å¤‡æŒ‡å®šçº¿ç¨‹è¿™äº›åŠŸèƒ½ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªå¤–å±‚å›è°ƒå»åŒ…è£…ç”¨æˆ·ä¼ å…¥çš„ä»£ç å—ï¼Œèµ‹äºˆæ•°çº¿ç¨‹åˆ‡æ¢çš„èƒ½åŠ›ï¼Œå°±åƒAOPã€‚

~~~java
public interface FakerInterceptor {
    public void dispatch(FakerJob callBack);
}
~~~

# è°ƒåº¦å™¨

ä¸Šæ–‡è¯´äº†è°ƒåº¦å™¨å°±æ˜¯å°±æ˜¯æ‹¦æˆªå™¨çš„å®ç°ï¼Œ

æˆ‘å†™äº†ä¸¤ä¸ªè°ƒåº¦å™¨ï¼Œ

1. å›ºå®š20ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± å®ç°çš„IOå¯†é›†å‹è°ƒåº¦å™¨ã€‚

2. ä½¿ç”¨Handlerå®ç°åˆ‡æ¢åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œçš„è°ƒåº¦å™¨ã€‚

ä½ è¦ä¸æ˜¯ä¸ªAndroidå¼€å‘è€…ï¼Œå¯èƒ½ä¸çŸ¥é“ä»€ä¹ˆæ˜¯Handlerã€‚é‚£ä½ å¯ä»¥å†™ä¸ªå•çº¿ç¨‹çš„çº¿ç¨‹æ± çš„è°ƒåº¦å™¨ï¼Œç„¶åå®ç°è‡ªå·±çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè‡³äºå¦‚ä½•å®ç°å»¶è¿Ÿäº‹ä»¶æ‰§è¡Œï¼Œè¾¾åˆ°æ¨¡æ‹Ÿçº¿ç¨‹çš„sleepåŠŸèƒ½ã€‚åªéœ€è¦è®°ä½ä¸€ä¸ªæ€æƒ³ï¼šå»¶è¿Ÿä¸æ˜¯é˜»å¡ï¼Œåªæ˜¯æŒ‚èµ·è¿™ä¸ªä»£ç å—ï¼Œè®©è¯¥çº¿ç¨‹å»æ¶ˆè´¹å…¶ä»–ä»£ç å—ï¼Œåˆ°æ—¶é—´å†å›æ¥æ‰§è¡Œã€‚å½“ç„¶å¦‚æœçº¿ç¨‹æœ¬æ¥å°±ç©ºé—²ï¼Œé‚£æ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆè´¹è€…ä¹Ÿæ˜¯ä¼šæœ‰ç­‰å¾…çš„æƒ…å†µï¼Œå®åœ¨ä¸ä¼šå†™å¯ä»¥å‚è€ƒandroidçš„handlerå®ç°ã€‚

~~~java

public class IODispatchers implements FakerInterceptor {
    private ExecutorService executor = Executors.newFixedThreadPool(20);

    @Override
    public void dispatch(FakerJob callBack) {
        executor.execute(callBack::start);
    }
}

public class MainDispatchers implements FakerInterceptor {
    private Handler executor = new Handler(Looper.getMainLooper());

    @Override
    public void dispatch(FakerJob callBack) {
        executor.post(callBack::start);
    }
}
~~~

å†™ä¸ªè°ƒåº¦å™¨çš„å£°æ˜ç±»ï¼š

~~~java
public class FakerDispatchers {
    public static FakerInterceptor IO = new IODispatchers();
    public static FakerInterceptor Main = new MainDispatchers();
}
~~~

# å›è°ƒæ„é€ 

æˆ‘ä»¬è¿˜éœ€è¦å®šä¹‰ä¸€ä¸ªå›è°ƒæ„é€ å™¨ï¼Œç»Ÿä¸€å¯¹å¤–apiï¼Œè®©ç”¨æˆ·æ–¹ä¾¿ä½¿ç”¨è¿™ä¸ªå¼ºå¤§çš„å›è°ƒï¼Œæœ‰äº›ä¸éœ€è¦ç»“æœä¹Ÿä¸æ‰§è¡Œè€—æ—¶æ“ä½œçš„ï¼ŒcallBackå¯ä»¥ç›´æ¥ä¼ å…¥nullï¼š

~~~java
public class FakerCompletionBuilder {

    public static void launch(FakerInterceptor dispatchers,FakerCallBack callBack, FakerContinuation fakerContinuation) {
        dispatchers.dispatch(new FakerJob() {
            @Override
            public void start() {
                if (callBack!=null) {
                    fakerContinuation.resumeWith(
                            callBack.invokeSuspend()
                    );
                }else {
                    fakerContinuation.resumeWith(null);
                }
            }
        });
    }
}
~~~

# æŒ‡å®šçº¿ç¨‹æ‰§è¡Œ

æ˜¯éª¡å­æ˜¯é©¬ï¼Œæ‹‰å‡ºæ¥æºœæºœï¼æˆ‘ç›´æ¥åœ¨androidçœŸæœºè·‘ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯kotlinï¼Œæ‡’å¾—æ”¹Activityçš„ä»£ç äº†ï¼Œçœ‹æ‡‚é—®é¢˜ä¸å¤§å§ï¼

~~~java
    fun launchTest() {
        FakerCompletionBuilder.launch {
            Log.d(">>> MainActivity", "launchTest ${Thread.currentThread().name}")
            val r = loadResult("addrC")
            FakerCompletionBuilder.launch(
                FakerDispatchers.Main) {
                Log.d(">>> MainActivity", "launchTest r = $r ${Thread.currentThread().name}")
            }
        }
    }

    private fun loadResult(addr: String): String? {
        try {
            if (addr == addrA) {
                Thread.sleep(1000)
            } else {
                Thread.sleep(3000)
            }

        } catch (e: InterruptedException) {
            e.printStackTrace()
        }
        return "load end $addr"
    }
~~~

æ³¨æ„ï¼Œè¿™é‡Œçš„ Thread.sleepæ˜¯ä¸ºäº†æ¨¡æ‹Ÿè€—æ—¶ï¼Œæ‰€ä»¥è¿™æ¬¡ä¸ç®—æ˜¯çº¿ç¨‹çŠ¶æ€å˜åŒ–å“ˆã€‚è¿è¡Œç»“æœï¼š

~~~txt
>>>Â MainActivity: launchTest  pool-1-thread-1
>>>Â MainActivity: launchTest result = load end addrA  main
~~~

å¾ˆé¡ºåˆ©å°±åˆ‡æ¢äº†çº¿ç¨‹ï¼

# èµ„æºç«äº‰

ç”±äºæˆ‘è¿™æ˜¯androidç¨‹åºï¼Œå¦‚æœåœ¨ä¸»çº¿ç¨‹é˜»å¡ç­‰å¾…ï¼Œç»“æœä¼šæœ‰è¯¯å·®ï¼Œæ‰€ä»¥æˆ‘å†åŠ ä¸€ä¸ªå•çº¿ç¨‹çš„è°ƒåº¦å™¨ï¼š

~~~java
public class SingleDispatchers implements FakerInterceptor {
    private ExecutorService executor = Executors.newSingleThreadExecutor();

    @Override
    public void dispatch(FakerJob callBack) {
        executor.execute(callBack::start);
    }
}


public class FakerDispatchers {
    public static FakerInterceptor IO = new IODispatchers();
    public static FakerInterceptor Main = new MainDispatchers();
    public static FakerInterceptor Single = new SingleDispatchers();
}
~~~

æˆ‘ç›´æ¥åœ¨androidçœŸæœºè·‘ï¼ŒActivityçš„ä»£ç éƒ½æ˜¯kotlinäº†æ‡’å¾—æ”¹ä»£ç äº†ï¼Œå·®ä¸å¤šçš„ï¼Œä½ åº”è¯¥çœ‹å¾—æ‡‚ï¼š

~~~kotlin
    var i = 0
    var j = 0

    fun testResourceCompetition() {
        (1..10000).forEach {
            load()
        }

        Thread.sleep(10000)
        println("i $i")
        println("j $j")
    }


    fun load() {
        FakerCompletionBuilder.launch(FakerDispatchers.IO, null) {
            j++
            FakerCompletionBuilder.launch(FakerDispatchers.Single,null) {
                 i++
            }
        }
    }
~~~

ç»“æœï¼š

~~~txt
I/System.out: i 10000
I/System.out: j 9869
~~~



jçš„å€¼æ¯æ¬¡éƒ½æ˜¯ä¸ä¸€æ ·ï¼Œè€Œiçš„å€¼ä¸€ç›´æ˜¯10000ã€‚ä¸éœ€è¦åŠ é”å°±è§£å†³äº†èµ„æºç«äº‰ï¼Œæœ‰æ„æ€å§ï¼

# åŠ è½½å¤šä¸ªå¼‚æ­¥èµ„æº

å¦‚æœåˆ©ç”¨ä¸Šæ–‡å®ç°çš„FakerCompletionBuilderï¼Œè¿›è¡Œå¹¶è¡ŒåŠ è½½èµ„æºï¼š

~~~java
    fun loadDouble() {
        var resultA: String? = null
        var resultB: String? = null
        FakerCompletionBuilder.launch(FakerDispatchers.IO, { loadResource(addrA) }) {result ->
            FakerCompletionBuilder.launch(FakerDispatchers.Main, null) {
                resultA = result.toString()
                if (resultB != null) {
                    Log.d(">>> MainActivity", "result = $resultA $resultB")
                }
            }
        }

        FakerCompletionBuilder.launch(FakerDispatchers.IO, { loadResource(addrB) }) {result->
            FakerCompletionBuilder.launch(FakerDispatchers.Main, null) {
                resultB = result.toString()
                if (resultA != null) {
                    Log.d(">>> MainActivity", "result = $resultA $resultB")
                }
            }
        }
    }
~~~

# å°ç»“

å®ç°ä¸€ä¸ªç®€å•çš„çº¿ç¨‹åˆ‡æ¢çš„å›è°ƒä¸éš¾ï¼Œåœ¨æœ€åä¸€ä¸ªä¾‹å­ä¸­ä¹Ÿç»™å‡ºäº†åŒæ­¥ä¸¤ä¸ªå¼‚æ­¥çº¿ç¨‹ç»“æœçš„æ–¹å¼ï¼ŒçœŸæ­£çš„æ ¸å¿ƒä»£ç æ‰§è¡Œçš„é¡ºåºæ˜¯è¿™æ ·ï¼š

~~~java
//è¿™ä¸¤ä¸ªæˆ‘ä»¬å¸Œæœ›å¹¶è¡Œ
loadResource(addrA) 
loadResource(addrB) 
//ä½†æœ€åä¸€å®šæ˜¯ï¼š
Log.d(">>> MainActivity", "result = $resultA $resultB") 
~~~

æˆ‘ä¸ºäº†å®ç°è¿™ç§æ•ˆæœï¼Œä½¿ç”¨å›è°ƒå°†ä¸‰æ¡è¯­å¥æ‹†å¼€ï¼Œå¹¶åˆ†åˆ«åŒ…è£…ï¼Œè¿™é‡Œå¯ä»¥è¯´ï¼šæˆ‘ç»™è¿™å‡ æ¡è¯­å¥æ”¾åœ¨äº†ä¸åŒçš„åç¨‹é‡Œã€‚

ç„¶åé€šè¿‡ä¸åŒçš„çº¿ç¨‹å»æ‰§è¡Œäº†loadResourceæ‰€åœ¨çš„åç¨‹ï¼Œæœ€åä½¿ç”¨ä½¿ç”¨æ§åˆ¶æµï¼Œè®©ç»“æœè¾“å‡ºçš„åç¨‹åœ¨æœ€åæ‰§è¡Œã€‚

å›é¡¾ä¸Šæ–‡å¯çŸ¥ï¼šå¯ä»¥é€šè¿‡çº¿ç¨‹å½±å“è¿™äº›å›è°ƒä»£ç å—çš„é¡ºåºã€‚ä½†ä»æœ€åè¿™ä¸ªä¾‹å­ä¸­ï¼Œè¿˜å¯ä»¥çœ‹åˆ°ï¼šæƒ³è¦ä»é¡ºåºä¸å—æ§çš„åç¨‹æ‰§è¡Œåï¼Œå¾—åˆ°æœŸæœ›é¡ºåºçš„æ‰§è¡Œç»“æœï¼Œè¿˜å¯ä»¥ä½¿ç”¨æ§åˆ¶æµå»å¤„ç†ï¼æ²¡æœ‰é˜»å¡ï¼Œæ²¡æœ‰é”ï¼æœ‰æ„æ€å§ï¼

ä»ä¸Šé¢çš„ä»£ç çœ‹åˆ°ï¼Œæ¡ä»¶åˆ¤æ–­è¯­å¥ä¼šæœ‰ä¸€äº›é‡å¤ä»£ç ï¼š

~~~kotlin
 resultB = result.toString()
 if (resultA != null) {
     Log.d(">>> MainActivity", "result = $resultA $resultB")
 }

 resultA = result.toString()
 if (resultB != null) {
     Log.d(">>> MainActivity", "result = $resultA $resultB")
 }
~~~

æ˜¯ä¸æ˜¯è§‰å¾—ï¼Œæˆ‘åº”è¯¥æŠ½å‡ºä¸€ä¸ªå‡½æ•°ï¼Ÿä¸ï¼åƒä¸‡ä¸è¦ï¼å› ä¸ºæˆ‘åœ¨å›è°ƒå‡½æ•°é‚£ä¸€å°ç»“è¯´äº†ï¼šæˆ‘å¸Œæœ›çš„æ˜¯åœ¨æŸä¸ªå‡½æ•°ä¸­å£°æ˜æˆ‘ä»¬æƒ³è¦çš„å‡½æ•°ï¼Œè€Œä¸æ˜¯åœ¨ç±»ä¸­åˆå»å£°æ˜å¦ä¸€ä¸ªå‡½æ•°ã€‚ç®€å•çš„è¯´ï¼šä¸æƒ³ä¸ºäº†æ”¹å˜è¿™ä¸ªå‡½æ•°çš„å†…éƒ¨è¡Œä¸ºï¼Œæ±¡æŸ“äº†å¤–éƒ¨çš„ç±»ï¼

å¹³æ—¶ï¼Œæˆ‘ä»¬é€šè¿‡æ§åˆ¶æµï¼Œå¯ä»¥ä½¿å¾—è¿™äº›ä»£ç çš„æ‰§è¡Œæ–¹å‘é¡ºåºå‘ç”Ÿå˜åŒ–ï¼Œä½†é€šè¿‡å›è°ƒå¤§æ³•å¯ä»¥æ§åˆ¶è¿™äº›ä»£ç å—çš„æ‰§è¡Œé¡ºåºï¼Œä½†ä¼šæœ‰ä¸€äº›é‡å¤çš„è¯­å¥ã€‚

# å½“å›è°ƒé‡è§switchï¼Œä¼šæ“¦å‡ºä»€ä¹ˆç«èŠ±ï¼Ÿ

å½“æœ‰å¾ˆå¤šæ¡è¯­å¥æ§åˆ¶æ¡ä»¶ï¼Œæˆ‘ä»¬ä¼šç”¨switchè¯­å¥ï¼Œæ§åˆ¶æ¡ä»¶å¯ä»¥ç»™ä¸ªçŠ¶æ€å€¼ã€‚æ˜¯çš„ï¼Œå°±æ˜¯çŠ¶æ€æœºï¼š

~~~java
public void test(state : Int) {
  switch (state) {
    case 0: {
      loadResource(addrA);	
      break;
    }
    case 1: {
      loadResource(addrB) 
      break;
    }
    case 2: {
      Log.d(">>> MainActivity", "result = $resultA $resultB")
      break;  
    }
  }
}
~~~

é€šè¿‡ä¼ å…¥çš„stateçš„å€¼ï¼Œå¯ä»¥æ§åˆ¶è¿™å‡ å¥ä»£ç çš„æ‰§è¡Œé¡ºåºã€‚

ä½†è°è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Ÿè°å­˜å‚¨è½¬æ€å€¼ï¼Ÿ

+ æ–¹æ¡ˆ1 ï¼šå¤–éƒ¨å†™ä¸€ä¸ªå¾ªç¯ï¼Œæ”¹å˜çŠ¶æ€çš„å€¼ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•

ä½†åœ¨ä¸å£°æ˜æ–°å‡½æ•°ï¼Ÿä¸å®šä¹‰æ–°æˆå‘˜å˜é‡çš„æ¸…ç†ä¸‹ï¼Œæ€ä¹ˆå®ç°ï¼Ÿ

+ æ˜¯çš„ï¼Œé—­åŒ…ï¼å›è°ƒï¼åŒ¿åå†…éƒ¨ç±»ï¼niceï¼æˆ‘ä»¬å¯ä»¥è¿™æ ·å†™ï¼š

~~~java
 public void loadDouble() {
  //å®ä¾‹åŒ–ä¸€ä¸ªåŒ¿åå†…éƒ¨ç±»ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„å›è°ƒï¼ŒåŒ…è£…æ•´ä¸ªloadDoubleæ–¹æ³•å†…éƒ¨çš„ä»£ç 
  FakerContinuation continuation= new FakerContinuation() {
    	//åˆå§‹åŒ–çŠ¶æ€
      int state = 0;
    	//æ¥æ”¶ä¸¤ä¸ªç»“æœ
      String resultA = null;
      String resultB = null;

      @Override
      public void resumeWith(Object obj) {
          switch (state) {
              case 0: {
                	//å°†åŠ è½½Açš„ä»£ç åŒ…è£…èµ·æ¥ï¼Œä¸¢ç»™å­çº¿ç¨‹æ‰§è¡Œï¼Œè¿™ä¸ªlaunchæ–¹æ³•å‰é¢æ²¡çœ‹åˆ°ï¼Œä¸‹é¢ä¼šè®²ï¼Œæ³¨æ„è¿™é‡Œä¼ äº†ä¸ªthis
                  FakerCompletionBuilder.launch(FakerDispatchers.Main, FakerDispatchers.IO, this, new FakerCallBack() {
                      @Override
                      public Object invokeSuspend() {
                        	//åŠ è½½èµ„æºA
                          return loadResource("A");
                      }
                  }, new FakerContinuation() {
                      @Override
                      public void resumeWith(Object obj) {
                        	//åŠ è½½èµ„æºAå®Œæˆåï¼Œå­˜å‚¨å€¼
                          resultA = obj.toString();
                      }
                  });
                  FakerCompletionBuilder.launch(FakerDispatchers.Main, FakerDispatchers.IO, this, new FakerCallBack() {
                      @Override
                      public Object invokeSuspend() {
                         	//åŠ è½½èµ„æºB
                          return loadResource("B");
                      }
                  }, new FakerContinuation() {
                      @Override
                      public void resumeWith(Object obj) {
                          //åŠ è½½èµ„æºBå®Œæˆåï¼Œå­˜å‚¨å€¼
                          resultB = obj.toString();
                      }
                  });
                	//å°†çŠ¶æ€åˆ‡æ¢ä¸º1
                  state = 1;
                  return; //é€€å‡ºæœ€å¤–å±‚çš„resumeWithæ–¹æ³•
              }
              case 1: {
                	//ä¸‹ä¸€æ¬¡è°ƒç”¨resumeWithæ–¹æ³•ï¼Œä¼šè¿›å…¥åˆ°è¯¥çŠ¶æ€ï¼Œ è¿›è¡Œåˆ¤æ–­ï¼Œä¸‹ä¸€æ¬¡è°è°ƒç”¨ï¼Œä¸‹é¢ä¼šè®²
                  if (resultA == null || resultB == null) {
                      return;
                  }
              }
          }
        	//è¾“å‡ºç»“æœ
          Log.d(">>> ", resultA + " " + resultB);
      }
  };
  //æ‰‹åŠ¨æ‰§è¡Œçˆ¶é—­åŒ…
  continuation.resumeWith(null);
 }
~~~

åˆ©ç”¨é—­åŒ…çš„ç‰¹æ€§ï¼Œå£°æ˜äº†é—­åŒ…å†…éƒ¨çš„æˆå‘˜å˜é‡ï¼Œç„¶ååˆå¯åŠ¨äº†ä¸¤ä¸ªåç¨‹è¿›è¡Œèµ„æºçš„åŠ è½½ï¼Œä½†æ˜¯åœ¨çŠ¶æ€0çš„æ—¶å€™å·²ç»returnäº†ï¼Œä¸ºä»€ä¹ˆä¼šé‡æ–°è¿›å…¥åˆ°switchï¼Ÿ

é‚£æ˜¯å› ä¸ºæˆ‘æ–°å¢äº†ä¸€ä¸ªå¯åŠ¨åç¨‹çš„æ–¹æ³•ï¼š

~~~java
//ä¼ äº†çˆ¶é—­åŒ…çš„è°ƒåº¦å™¨ï¼Œå’Œçˆ¶é—­åŒ…
public static void launch(FakerInterceptor dispatchersParen, FakerInterceptor dispatchers, FakerContinuation continuationParen, FakerCallBack callBack, FakerContinuation continuation) {
        dispatchers.dispatch(new FakerJob() {
            @Override
            public void start() {
                Object obj = callBack.invokeSuspend();
                continuation.resumeWith(obj);

              	//æ³¨æ„è¿™é‡Œï¼Œä½¿ç”¨çˆ¶é—­åŒ…çš„è°ƒåº¦å™¨æ‰§è¡Œé‡æ–°æ‰§è¡Œäº†çˆ¶é—­åŒ…çš„resumeWithï¼Œå¹¶å°†ç»“æœä¼ è¿‡å»äº†ï¼Œæ‰€ä»¥åˆšåˆšçš„switchå¯ä»¥æ‰§è¡Œ
                dispatchersParen.dispatch(new FakerJob() {
                    @Override
                    public void start() {
                        continuationParen.resumeWith(obj);
                    }
                });
            }
        });
    }
~~~

ä¸æ˜¯è¯´ä¸åŠ æ–°æ–¹æ³•å—ï¼Ÿå“ˆå“ˆï¼Œæˆ‘è¿™é‡ŒåŠ çš„æ˜¯ä¸€ä¸ªé€šç”¨çš„åç¨‹å¯åŠ¨æ–¹æ³•ï¼Œè¦æƒ³å®ç°ä¸Šæ–‡è¯´çš„æ•ˆæœï¼Œæœ€å¥½çš„æ–¹å¼å°±æ˜¯åŠ è¿™ä¸ªæ–¹æ³•å•¦ï¼è€Œä¸”è¯¥æ–¹æ³•æ˜¯FakerCompletionBuilderä¸­å®šä¹‰çš„ï¼Œå¹¶æ²¡æœ‰æ±¡æŸ“åŸæœ¬çš„ç±»å’Œå‡½æ•°ã€‚

ä¸ºä»€ä¹ˆåšäº†ä¸ªçˆ¶é—­åŒ…è°ƒåº¦å™¨çš„åˆ‡æ¢ï¼Ÿå¿…é¡»çš„å‘€ï¼å› ä¸ºæˆ‘ä»¬æœŸæœ›çš„å°±æ˜¯ä¸‹é¢è¿™æ ·çš„æ‰§è¡Œæ•ˆæœï¼š

~~~kotlin
suspend fun showHtmlPage () {
  val resultA = async{loadResource(addrA)} //å¼‚æ­¥çº¿ç¨‹æ‰§è¡Œ
  val resultB = async{loadResource(addrB)} //å¼‚æ­¥çº¿ç¨‹æ‰§è¡Œ
  log(resultA,resultB) //ä¸»çº¿ç¨‹æ‰§è¡Œ
}
~~~

ä¸€æ ·æ²¡æœ‰åŠ é”ï¼åˆ¤æ–­è¯­å¥ä¸å†æ˜¯é‡å¤ä»£ç ï¼çœ‹å§ï¼switchå’Œå›è°ƒåœ¨ä¸€èµ·ï¼Œç»•æ˜¯æŒºç»•çš„ï¼Œä½†æ˜¯å¾ˆæœ‰æ„æ€å¯¹å§ï¼è¿™æ®µå…¶å®å·²ç»å¾ˆæ¥è¿‘åç¨‹äº†ï¼Œæ€æƒ³å…¶å®å·²ç»ä½“ç°å‡ºæ¥äº†ï¼Œå»ºè®®å†ç»†ç»†å“å‘³ä¸€ä¸‹ï¼ï¼ï¼

# å°ç»“

switchå°†éœ€è¦å¼‚æ­¥æ‰§è¡Œå’ŒåŒæ­¥æ‰§è¡Œçš„è¯­å¥ï¼Œåˆ†åˆ«åˆ’åˆ†åœ¨ä¸åŒçš„é—­åŒ…ä¸­ï¼Œæ¯æ‰§è¡Œå®Œä¸€ä¸ªé—­åŒ…å°±æ”¹å˜lableçš„å€¼ï¼ˆæ”¹å˜æ‰§è¡ŒçŠ¶æ€ï¼‰ï¼Œç„¶åé€šè¿‡å­é—­åŒ…é‡æ–°è°ƒç”¨çˆ¶é—­åŒ…çš„å›è°ƒæ–¹æ³•ï¼Œçˆ¶é—­åŒ…çš„resumeWithæ–¹æ³•é‡æ–°è¿›å…¥åï¼Œç”±äºçŠ¶æ€æ”¹å˜äº†ï¼Œæ‰€ä»¥æ‰§è¡Œäº†ä¸åŒä¸ä¸Šä¸€æ¬¡çš„ä»£ç å—ã€‚å°±å®ç°äº†åœ¨çˆ¶é—­åŒ…ä¸­ï¼Œå„ä¸ªä¸åŒä»£ç å—æ‰§è¡ŒçŠ¶æ€çš„æµè½¬ï¼Œè¿›è€Œå®ç°è¡¨ç°ä¸Šçš„åŒæ­¥å¾—åˆ°ç»“æœã€‚

è®¤çœŸæƒ³æƒ³ï¼Œå…¶å®å°±æ˜¯å°†ä¸€ä¸ªå®Œæ•´çš„ä»£ç å—ï¼Œæ ¹æ®å¼€å‘è€…çš„å£°æ˜ï¼ˆä¾‹å¦‚ï¼šlaunch{}ï¼‰ï¼Œæ‹†æˆä¸åŒçš„ä»£ç å—ï¼Œä½¿ç”¨é—­åŒ…åŒ…è£…èµ·æ¥ï¼Œç„¶åæ ¹æ®å„ä¸ªä»£ç å—çš„æƒ…å†µè°ƒæ•´çŠ¶æ€ï¼Œæ”¹å˜äº†æ‰€æœ‰ä»£ç å—çš„æ‰§è¡Œé¡ºåºã€‚æ³¨æ„ï¼è¿™é‡Œå¼ºè°ƒäº†å¼€å‘è€…çš„å£°æ˜ï¼Œå¾ˆæ˜æ˜¾ï¼Œåˆ†å—å…¶å®æ˜¯ç”±å¼€å‘è€…å†³å®šçš„ï¼ä¹Ÿå°±æ˜¯ç¨‹åºå†³å®šçš„ï¼

è¿™é‡Œå°è¯äº†ä¸Šæ–‡çš„ï¼š**å°†è¦æ‰§è¡Œçš„ä»£ç ä½¿ç”¨å›è°ƒ â€åŒ…è£…èµ·æ¥â€œï¼Œåœ¨åˆé€‚çš„æ—¶æœºæ‰§è¡Œï¼è¿™æ˜¯çº¿ç¨‹å›è°ƒä½¿å¾—ä»£ç æ‰§è¡Œé¡ºåºæµè½¬çš„æœ€å¥½ä½“ç°ï¼ä¹Ÿæ˜¯æ— æ ˆåç¨‹å®ç°æ‰§è¡ŒçŠ¶æ€æµè½¬çš„é‡è¦å‰æä¹‹ä¸€ï¼**

è¿™é‡Œå…¶å®å¯ä»¥çœ‹åšä¸€ä¸ªç‰¹æ®Šçš„å¾ªç¯ï¼ï¼ï¼Œå…¶å®å¾ˆå¤šæ—¶å€™æˆ‘ä»¬åœ¨

# éƒé—·

ä½†æ˜¯æœ‰ä¸¤ä¸ªåœ°æ–¹å¾ˆéƒé—·ï¼š

1.åˆ‡æ¢åˆ°çˆ¶é—­åŒ…çš„è°ƒåº¦å™¨å»å›è°ƒresumeWithæ–¹æ³•ï¼Œè€Œæˆ‘çš„ä¸»çº¿ç¨‹è°ƒåº¦å™¨æ˜¯å°†é—­åŒ…ä¸¢åˆ°äº†é˜Ÿåˆ—é‡Œé¢ï¼Œå¦‚æœéƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œåˆå¾—ç­‰ä¸€ä¼šæ‰èƒ½æ‰§è¡Œï¼Œè¿™ä¸ªç­‰ä¸€ä¸‹æ˜¯å¦å¿…è¦ï¼Ÿ



2.æˆ‘ä»¬æ˜æ˜å·²ç»å°†ç»“æœé€šè¿‡çˆ¶é—­åŒ…çš„resumeWithæ–¹æ³•è¿”å›äº†ï¼Œä¸ºä»€ä¹ˆswitchä¸­è¿˜è¦åœ¨å­é—­åŒ…ä¸­çš„resumeWithæ–¹æ³•èµ‹å€¼ï¼Ÿ

~~~java
//ä¼ äº†çˆ¶é—­åŒ…çš„è°ƒåº¦å™¨ï¼Œå’Œçˆ¶é—­åŒ…
public static void launch(FakerInterceptor dispatchersParen, FakerInterceptor dispatchers, FakerContinuation continuationParen, FakerCallBack callBack, FakerContinuation continuation) {
     ....

              	//æ³¨æ„è¿™é‡Œï¼Œä½¿ç”¨çˆ¶é—­åŒ…çš„è°ƒåº¦å™¨æ‰§è¡Œé‡æ–°æ‰§è¡Œäº†çˆ¶é—­åŒ…çš„resumeWithï¼Œå¹¶å°†ç»“æœä¼ è¿‡å»äº†ï¼Œæ‰€ä»¥åˆšåˆšçš„switchå¯ä»¥æ‰§è¡Œ
                dispatchersParen.dispatch(new FakerJob() {
                    @Override
                    public void start() {
                      //è¿™é‡Œï¼ï¼ï¼
                        continuationParen.resumeWith(obj);
                    }
                });
            }
        });
    }
~~~



~~~java
...
  }, new FakerContinuation() {
                      @Override
                      public void resumeWith(Object obj) {
                        	//åŠ è½½èµ„æºAå®Œæˆåï¼Œå­˜å‚¨å€¼
                          resultA = obj.toString();
                      }
                  });
  ...
~~~

é‚£æ˜¯å› ä¸ºæˆ‘ä¸çŸ¥æ˜¯è°ä¼ è¿›æ¥çš„ç»“æœï¼Œæ— æ³•ç¡®è®¤æ˜¯ç»“æœAè¿˜æ˜¯ç»“æœBï¼ç®€å•åœ°è¯´ï¼šæˆ‘ä¸çŸ¥é“Aå’ŒBçš„å›è°ƒé¡ºåºï¼

å› ä¸ºè¿™é‡Œä¸æ˜¯Kotlinåç¨‹çš„çœŸæ­£å®ç°ï¼Œæ˜¯æˆ‘è‡ªå·±å†™çš„ä¾‹å­ã€‚å› ä¸ºä¸æƒ³è¿™ä¹ˆæ—©ä¸¢å‡ºawaitï¼Œå®¢å®˜ä¸è¦æ€¥å˜›ï¼ç­‰åˆ°ä¸‹æ–‡è®²åˆ°awaitåï¼Œè¿™ä¸ªé—®é¢˜å°±è¿åˆƒè€Œè§£äº†ï¼

# æ˜¯å¦å€¼å¾—æŒ‚èµ·

> åˆ‡æ¢åˆ°äº†çˆ¶é—­åŒ…çš„è°ƒåº¦å™¨å»å›è°ƒresumeWithæ–¹æ³•ï¼Œå› ä¸ºæˆ‘è¿™é‡Œçš„ä¸»çº¿ç¨‹è°ƒåº¦å™¨æ˜¯å°†é—­åŒ…ä¸¢åˆ°äº†é˜Ÿåˆ—é‡Œé¢ï¼Œå¦‚æœéƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œåˆå¾—ç­‰ä¸€ä¼šæ‰èƒ½æ‰§è¡Œï¼Œè¿™ä¸ªç­‰ä¸€ä¸‹æ˜¯å¦å¿…è¦ï¼Ÿ

æ˜¯çš„ï¼Œæˆ‘æ„Ÿè§‰æ²¡å¿…è¦ï¼æ‰€ä»¥kotlinä¸­æœ‰æ ‡å¿—å£°æ˜æ˜¯å¯èƒ½æŒ‚èµ·ï¼è€Œä¸æ˜¯ä¸€å®šæŒ‚èµ·ï¼å¦‚ï¼šå‡½æ•°å¼€å¤´ä¸­çš„suspendçš„å…³é”®å­—ã€é—­åŒ…æ‰§è¡Œçš„è¿”å›å€¼ã€‚

å’¦ï¼ä¸çŸ¥ä¸è§‰å°±å‘Šè¯‰äº†ä½ ï¼šæŒ‚èµ·ï¼Œç®€å•çš„ç†è§£å°±æ˜¯æš‚æ—¶ä¸æ‰§è¡Œè¿™ä¸ªé—­åŒ…ï¼

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨æœ€ç®€å•çš„æ–¹å¼æ¨¡æ‹Ÿä¸€ä¸‹ï¼Œå‰ææ¡ä»¶æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œè¯·ç‰¢è®°è¿™ä¸ªï¼

ç”±äºåœ¨kotlinä¸­ï¼Œlaunchçš„è¿”å›å€¼æ˜¯ä¸ªjobï¼Œæ‰€ä»¥æˆ‘è§‰å¾—ä½¿ç”¨asyncæ›´è´´åˆ‡ä¸€ç‚¹ï¼Œæ³¨æ„ï¼kotlinçš„å®ç°ä¸æ˜¯è¿™æ ·çš„ï¼Œä½†æ˜¯ä¸ºäº†è®©ä½ æ›´åŠ ç®€å•çš„æ˜ç™½ä¸ºä»€ä¹ˆä¸éœ€è¦æŒ‚èµ·ï¼Œä¸ºäº†æ›´ç®€å•çš„è¯´æ˜æŒ‚èµ·çš„æ€æƒ³ï¼Œå°±æ‰‹å†™äº†è¿™ä¸ªä¾‹å­ï¼Œè¯·åŠ¡å¿…çŸ¥æ‚‰ï¼š

~~~java
//å®šä¹‰ä¸€ä¸ªæ ‡å¿—ä½
final int SUSPEDN = 1ï¼›

//å¢åŠ ä¸€ä¸ªè¿”å›å€¼
public static Object async(FakerInterceptor dispatchersParen, FakerInterceptor dispatchers, FakerContinuation continuationParen, FakerCallBack callBack, FakerContinuation continuation) {
    	//æ³¨æ„è¿™é‡Œï¼Œå¦‚æœè°ƒåº¦å™¨ä¸ç­‰äºçˆ¶åç¨‹çš„è°ƒåº¦å™¨ï¼Œå°±æŒ‚èµ·
        if (dispatchers != dispatchersParen) {
            dispatchers.dispatch(new FakerJob() {
                @Override
                public void start() {
                    Object obj = callBack.invokeSuspend();
                    continuation.resumeWith(obj);

                    dispatchersParen.dispatch(new FakerJob() {
                        @Override
                        public void start() {
                            continuationParen.resumeWith(obj);
                        }
                    });
                }
            });
          	//è¿”å›è¿™ä¸ªæ ‡å¿—ä½
            return SUSPEDN;
        } else { //å¦åˆ™æ²¡å¿…è¦æŒ‚èµ·
            Object obj = callBack.invokeSuspend();
            continuation.resumeWith(obj); //å­é—­åŒ…ä¹Ÿä¼ é€’ç»“æœ
            return obj; //ç›´æ¥æ‰§è¡Œï¼Œç›´æ¥è¿”å›ç»“æœ
        }
    }
~~~

å°±æ˜¯è¿”å›ä¸€ä¸ªæ ‡å¿—ä½å‘Šè¯‰switchæ˜¯å¦éœ€è¦åˆ‡æ¢çŠ¶æ€è€Œå·²ï¼Œä½¿ç”¨çœ‹çœ‹å°±çŸ¥é“äº†ï¼š

~~~java
    public void loadDouble() {
        FakerContinuation continuation= new FakerContinuation() {
            int state = 0;
            String resultA = null;
            String resultB = null;
            Object resultLaunchB ;

            @Override
            public void resumeWith(Object obj) {
                switch (state) {
                    case 0: {
                        Object resultLaunchA = FakerCompletionBuilder.async(FakerDispatchers.Main, FakerDispatchers.Main, this, new FakerCallBack() {
                            @Override
                            public Object invokeSuspend() {
                                return loadResource("A");
                            }
                        }, new FakerContinuation() {
                            @Override
                            public void resumeWith(Object obj) {
                                resultA = obj.toString();
                            }
                        });
                        resultLaunchB = FakerCompletionBuilder.async(FakerDispatchers.Main, FakerDispatchers.IO, this, new FakerCallBack() {
                            @Override
                            public Object invokeSuspend() {
                                return loadResource("B");
                            }
                        }, new FakerContinuation() {
                            @Override
                            public void resumeWith(Object obj) {
                                resultB = obj.toString();
                            }
                        });            
                        state = 1;
                      	//æ³¨æ„è¿™é‡Œï¼Œå†³å®šäº†è¦ä¸è¦è·³é—­åŒ…ç­‰å¾…ä¸‹ä¸€æ¬¡çŠ¶æ€åˆ‡æ¢ï¼Œè¿˜æ˜¯ç»§ç»­æ‰§è¡Œä»£ç 
                        if (resultLaunchA == SUSPEDN) {
                            return;
                        }else {
                            resultA = resultLaunchA.toString();
                        }
                        if (resultLaunchB == SUSPEDN) {
                            return;
                        }else {
                            resultB = resultLaunchB.toString();
                        }
                    }
                    case 1: {
                        if (resultA == null || resultB == null) {
                            return;
                        }
                        break;
                    }
                }
                Log.d(">>> ", resultA + " " + resultB);
            }
        };
        continuation.resumeWith(null);
    }
~~~

è¦ä¸è¦ç»§ç»­è·³å‡ºswitchï¼Œæ˜¯ç”±asyncçš„è¿”å›å€¼å†³å®šçš„ï¼Œæ‰€ä»¥è¦ä¸è¦æŒ‚èµ·ï¼Œå…¶å®å°±æ˜¯æŒ‡ï¼š

+ æ˜¯åº”è¯¥å°†ä¸¤ä¸ªä»£ç åˆ†æˆä¸¤ä¸ªä»£ç å—ï¼Œç„¶åæœ‰é¡ºåºçš„æ‰§è¡Œï¼›
+ æˆ–æ˜¯ä¸åˆ†å¼€ä¸¤éƒ¨åˆ†ä»£ç ï¼Œç›´æ¥æ‰§è¡Œä¸‹å»ã€‚

è¿™ä¸‹æˆ‘ä»¬çŸ¥é“äº†ï¼Œæ˜¯å¦æŒ‚èµ·ï¼Œæ˜¯ä¸ä¸€å®šçš„ï¼Œè¦çœ‹å…·ä½“æ¡ä»¶ï¼Œåœ¨kotlinä¸­å°±æ˜¯é€šè¿‡è¿”å›å€¼å£°æ˜çš„å“¦ï¼

# å®ç°delay

ä½†æœ‰ä¸ªæƒ…å†µæ˜¯å¿…ç„¶ä¼šæŒ‚èµ·çš„ï¼é‚£å°±æ˜¯delayï¼delayçš„æ„æ€å¾ˆæ˜ç¡®ï¼Œå°±æ˜¯å»¶è¿Ÿä¸€ä¸‹å†æ‰§è¡Œï¼Œä½“ç°æŒ‚èµ·è¿™ä¸ªè¡Œä¸ºçš„æœ€ä½³ä¾‹å­ï¼

æˆ‘ä»¬çŸ¥é“Thread.sleepæ˜¯ä¼šé˜»å¡çš„ï¼Œdelayä¸ºä»€ä¹ˆä¸ä¼šé˜»å¡ï¼Ÿè€Œæ˜¯æŒ‚èµ·ï¼Ÿå¦‚æœä½ å·²ç»ç†è§£äº†ä¸Šæ–‡çš„å†…å®¹ï¼Œå…¶å®ä½ å¿ƒä¸­å·²ç»æœ‰ç­”æ¡ˆäº†ï¼ä¸ç†è§£ä¹Ÿæ²¡å…³ç³»ï¼Œå†å¾€ä¸‹çœ‹çœ‹è¯´ä¸å®šå°±æ¸…æ™°äº†ï¼

æˆ‘ä»¬è¦å®ç°è¿™æ ·çš„æ•ˆæœï¼š

~~~java
log(1)
delay(1000) //å»¶æ—¶ä¸€ç§’åå†å¾€ä¸‹æ‰§è¡Œï¼Œä½†æ˜¯çº¿ç¨‹ä¸é˜»å¡
log(2)
~~~

**æ³¨æ„ï¼ æˆ‘è¿™é‡Œå°±ä½¿ç”¨ä¸»çº¿ç¨‹è°ƒåº¦å™¨çš„å®ç°ï¼Œå› ä¸ºç®€å•ï¼Œä¸ºä»€ä¹ˆç®€å•ï¼Ÿandroidå¼€å‘è€…çœ‹åˆ°åï¼Œä¸€å®šä¼šç›´å‘¼å†…è¡Œï¼**

å…ˆæ”¹æ”¹ä¸»çº¿ç¨‹çš„è°ƒåº¦å™¨ï¼š

~~~java
public class MainDispatchers implements FakerInterceptor {
    private Handler executor = new Handler(Looper.getMainLooper());

    @Override
    public void dispatch(FakerJob callBack) {
        executor.post(callBack::start);
    }

  	//æ˜¯çš„ï¼Œå°±æ˜¯postDelayedï¼ŒæƒŠä¸æƒŠå–œæ„ä¸æ„å¤–ï¼Ÿï¼Œæ‰€ä»¥è¯´ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹çœŸçš„å¾ˆå‰å®³ï¼
    @Override
    public void dispatch(Long time,FakerJob callBack) {
        executor.postDelayed(callBack::start,time);
    }
}

~~~

å†åˆ›å»ºä¸€ä¸ªdelayçš„æ„é€ å™¨ï¼š

~~~java
    public static Object delay(Long time, FakerInterceptor dispatchersParen, FakerContinuation continuationParen) {
        dispatchersParen.dispatch(time, new FakerJob() {
            @Override
            public void start() {
              	//å»¶è¿Ÿç»“æŸ
                continuationParen.resumeWith(SUSPEDN_FINISH);
            }
        });
      	//å»¶è¿Ÿ
        return SUSPEDN;
    }
~~~

ä½¿ç”¨ï¼š

~~~java
    public void test() {
        FakerContinuation continuation = new FakerContinuation() {
            int state = 0;
            Object resultLaunchB;

            @Override
            public void resumeWith(Object obj) {
                switch (state) {
                    case 0: {
                        Log.d(">>> ", "1");
                        state = 1;
                      	//æ³¨æ„è¿™ä¸ªthisï¼Œå°±æ˜¯çˆ¶é—­åŒ…çš„å¼•ç”¨ï¼Œæ‰€ä»¥å»¶æ—¶ä»»åŠ¡æ˜¯é‡æ–°å›è°ƒçˆ¶é—­åŒ…çš„resumeWithæ–¹æ³•
                        Object result = FakerCompletionBuilder.delay(1000L, FakerDispatchers.Main, this);
                        if (result == SUSPEND) {
                            return;
                        }
                    }
                    case 1: {
                        Log.d(">>> ", "2");
                    }
                }
            }
        };
        continuation.resumeWith(null);
    }
~~~

ç®€å•å§ï¼Œå°±æ˜¯åŠ å…¥é˜Ÿåˆ—ï¼Œç„¶åæ’é˜Ÿå»äº†ï¼åˆ°äº†æ—¶é—´åæ‰å›åˆ°çˆ¶é—­åŒ…çš„resumeWithï¼Œä»è€Œè¿›å…¥åˆ°çŠ¶æ€2ã€‚è¿™é‡Œå°±åƒæœ¬æ–‡ä¸€å¼€å§‹çš„æ•…äº‹ä¸­å†™çš„ä¸€æ ·ï¼š

log2ä¸»åŠ¨è®©å‡ºäº†1ç§’ï¼ç„¶åä¸»çº¿ç¨‹å»æ¶ˆè´¹é˜Ÿåˆ—ä¸­çš„æ‰§è¡Œå…¶ä»–äº‹ä»¶ï¼

# å®ç°await

æ¥çœ‹çœ‹ä¸Šæ–‡æåˆ°çš„å¦ä¸€ä¸ªé—®é¢˜ï¼š

> æˆ‘ä»¬æ˜æ˜å·²ç»å°†ç»“æœé€šè¿‡çˆ¶é—­åŒ…çš„resumeWithæ–¹æ³•è¿”å›äº†ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¯´çš„ç»­ä½“ä¼ é€’é£æ ¼ï¼Œä¸ºä»€ä¹ˆswitchä¸­è¿˜è¦åœ¨å­é—­åŒ…ä¸­çš„resumeWithæ–¹æ³•èµ‹å€¼ï¼Ÿ

å› ä¸ºåœ¨ä¸ç»™è¿”å›ç»“æœæ·»åŠ æ ‡å¿—ä½çš„æƒ…å†µä¸‹ï¼Œä¸å¥½æ§åˆ¶åŠ è½½èµ„æºAå’ŒBçš„è¿”å›ç»“æœï¼é‚£æˆ‘æ¢ä¸ªæ€è·¯ï¼Œç»™ä¸ªå¯¹è±¡å»å­˜å‚¨å¼‚æ­¥çš„ç»“æœï¼Œå½“ç»“æœåˆ°äº†æ—¶å€™ï¼Œé€šçŸ¥çˆ¶é—­åŒ…ã€‚ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ

javaç¨‹åºå‘˜å¤§å¤šçŸ¥é“Futureï¼Œå› ä¸ºrunnableæ²¡æœ‰ç»“æœè¿”å›ï¼Œæ­£å¦‚æˆ‘ä»¬ä¸Šæ–‡çš„Jobä¸€æ ·ï¼š

~~~java
public interface FakerJob {
    public void start();
}
~~~

æ‰€ä»¥javaæä¾›äº†ä¸ªFutureæ¥è·å–runnableæ‰§è¡Œå®Œçš„ç»“æœï¼Œä½†Futureæ˜¯é˜»å¡çš„ï¼Œè€Œåæˆ‘ä»¬è¦å®ç°çš„æ˜¯éé˜»å¡çš„Futureï¼š

~~~java
public interface LightFuture {
    public Object await(FakerContinuation continuation);
}
~~~

æ˜¯ä¸æ˜¯æœ‰deferredçš„å‘³é“äº†ï¼Ÿçœ‹çœ‹å…·ä½“å®ç°å§ï¼Œéƒ½åœ¨æ³¨é‡Šé‡Œé¢äº†ï¼š

~~~java
public class LightFutureImpl implements LightFuture, FakerContinuation {

  	//çŠ¶æ€ï¼Œå¼‚æ­¥åç¨‹æ˜¯å¦æ‰§è¡Œå®Œæ¯•
    public boolean isCompleted = false;
  	//å­˜å‚¨å¼‚æ­¥åç¨‹æ‰§è¡Œçš„ç»“æœ
    public Object result;
  	//çˆ¶é—­åŒ…çš„å¼•ç”¨
    public FakerContinuation continuation;

  	//è¿™ä¸ªæ–¹æ³•å¾ˆç†Ÿæ‚‰äº†ï¼Œä¼ å…¥çˆ¶é—­åŒ…ï¼Œå¦‚æœç»“æœå·²ç»æœ‰äº†ï¼Œç›´æ¥è¿”å›ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå‘ŠçŸ¥çˆ¶é—­åŒ…è¿™é‡Œåº”è¯¥æŒ‚èµ·ï¼
    public Object await(FakerContinuation continuation) {
        this.continuation = continuation;
        if (isCompleted) {
            return result;
        }
        return FakerContinuation.SUSPEDN;
    }

  	//å¼‚æ­¥åç¨‹é€šçŸ¥è¯¥Futureç»“æœå·²ç»è·å–äº†
    @Override
    public void resumeWith(Object obj) {
        isCompleted = true;
        result = obj;
      	//çˆ¶åç¨‹æ²¡æœ‰ï¼Œå°†ç»“æœå­˜ä¸‹æ¥ï¼Œä½†æ˜¯ä¸å›è°ƒ
        if (continuation != null) {
          	//é€šçŸ¥çˆ¶åç¨‹ç»“æœå·²ç»æ‹¿åˆ°ï¼Œå¯ä»¥è¿›å…¥åˆ°ä¸‹ä¸€ä¸ªçŠ¶æ€äº†
            continuation.resumeWith(obj);
        }
    }
}
~~~

å®šä¹‰æˆ‘ä»¬çš„asyncæ„é€ å™¨ï¼š

~~~java
public static LightFuture async(FakerInterceptor dispatchersParen, FakerInterceptor dispatchers, FakerCallBack callBack) {
  			//å®ä¾‹åŒ–ä¸€ä¸ªLightFutureImpl
        LightFutureImpl lightFuture = new LightFutureImpl();
        dispatchers.dispatch(new FakerJob() {
            @Override
            public void start() {
                Object result = callBack.invokeSuspend();
              	//æ³¨æ„è¿™æ˜¯åˆ‡æ¢å›äº†çˆ¶åç¨‹çš„è°ƒåº¦å™¨
                dispatchersParen.dispatch(new FakerJob() {
                    @Override
                    public void start() {
                      	//æ³¨æ„çœ‹è¿™é‡Œï¼Œåœ¨å¼‚æ­¥åç¨‹æ‰§è¡Œå®Œæˆåï¼Œå°†ç»“æœå­˜åˆ°LightFutureImplä¸­
                        lightFuture.resumeWith(result);
                    }
                });
            }
        });
        return lightFuture;
    }
~~~

ä½¿ç”¨ï¼š

~~~java
    public void test() {
        FakerContinuation continuation = new FakerContinuation() {
            int state = 0;
          	//ç”¨æ¥è·å–ç»“æœBçš„Future
            LightFuture futureB;
            Object resultB;

            @Override
            public void resumeWith(Object obj) {
              	//æ³¨æ„ï¼Œè¿™é‡Œå®šä¹‰ä¸€ä¸ªä½œç”¨åŸŸlable17
                lable17:
                {
                  	//å­˜å‚¨å…¶ä»–åç¨‹ä¼ é€’çš„ç»“æœ
                    resultB = obj;
                    switch (state) {
                        case 0: {
                          	//å¯åŠ¨åç¨‹ï¼ŒåŠ è½½èµ„æºA
                            LightFuture futureA = FakerCompletionBuilder.async(FakerDispatchers.Single, FakerDispatchers.IO, new FakerCallBack() {
                                @Override
                                public Object invokeSuspend() {
                                    return loadResource("A");
                                }
                            });
                          //å¯åŠ¨åç¨‹ï¼ŒåŠ è½½èµ„æºB
                            futureB = FakerCompletionBuilder.async(FakerDispatchers.Single, FakerDispatchers.IO, new FakerCallBack() {
                                @Override
                                public Object invokeSuspend() {
                                    return loadResource("B");
                                }
                            });
                          	//çŠ¶æ€æ”¹ä¸º1
                            state = 1;
                          	//å°è¯•å»å–ç»“æœï¼Œæ³¨æ„è¿™é‡Œä¼ å…¥äº†çˆ¶é—­åŒ…çš„å¼•ç”¨
                            Object result = futureA.await(this);
                          	//å–ä¸åˆ°ç»“æœï¼Œç›´æ¥æŒ‚èµ·ï¼Œé€€å‡ºè¿™ä¸ªçˆ¶é—­åŒ…ï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªçŠ¶æ€çš„åˆ°æ¥
                            if (result == FakerContinuation.SUSPEDN) {
                                return;
                            }
                        }
                        //åç¨‹Aæ‰§è¡Œå®Œæˆï¼Œè¿›å…¥äº†è¿™ä¸ªçŠ¶æ€ï¼Œä½†æˆ‘ä»¬å•¥ä¹Ÿä¸å¹²ç›´æ¥è·³å‡ºswitchï¼Œä¸ºä»€ä¹ˆä¸€å®šæ˜¯åç¨‹Aï¼Œç¨åè®²
                        case 1: {
                            break;
                        }
                        case 2: {
                          	//ç›´æ¥è·³å‡ºlable17ï¼Œæ³¨æ„æ˜¯lable17ï¼
                            break lable17;
                        }
                    }
                  	//ä»çŠ¶æ€1åˆ°è¿™é‡Œï¼Œè¾“å‡ºåç¨‹Aæ‰§è¡Œçš„ç»“æœ
                    System.out.println(">>>"+obj.toString());
                  	//çŠ¶æ€åˆ‡åˆ°2
                    state = 2;
                    //å°è¯•å–å‡ºç»“æœï¼Œæ³¨æ„è¿™é‡Œä¼ å…¥äº†çˆ¶é—­åŒ…çš„å¼•ç”¨
                    resultB = futureB.await(this);
                    //å°è¯•å–ä¸åˆ°ï¼Œå°±æŒ‚èµ·ï¼Œç­‰å¾…åç¨‹Bå›è°ƒè¯¥çˆ¶é—­åŒ…ï¼Œè¿›å…¥çŠ¶æ€2
                    if (resultB == FakerContinuation.SUSPEDN) {
                        return;
                    }

                }// lable17 end
              	//è¿™å¥ä¸€å®šæ˜¯ä»çŠ¶æ€2è¿‡æ¥çš„ï¼Œæ‰€ä»¥ç›´æ¥è¾“å‡ºBç»“æœ
                System.out.println(">>>"+resultB.toString());
            }
        };
     
        continuation.resumeWith(null);
    }

    private String loadResource(String addr) {
        try {
            if (addr.equals("A")) {
                Thread.sleep(1000);
            } else {
                Thread.sleep(2000);
            }
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

        return "load end " + addr;
    }
~~~

å¾ˆç¥å¥‡æ˜¯å—ï¼Ÿä¸ºä»€ä¹ˆä¸€å®šæ˜¯åç¨‹Aè¿›å…¥çŠ¶æ€1ï¼Ÿ

å› ä¸ºæˆ‘ä»¬åœ¨çŠ¶æ€1å‰éƒ½æ²¡æœ‰è°ƒç”¨è¿‡ï¼š

~~~java
//å°è¯•å–å‡ºç»“æœï¼Œæ³¨æ„è¿™é‡Œä¼ å…¥äº†çˆ¶é—­åŒ…çš„å¼•ç”¨
resultB = futureB.await(this);
~~~

æ‰€ä»¥åç¨‹Bå°±ç®—æ‰§è¡Œå®Œæˆäº†ï¼Œä¹Ÿä¸ä¼šå›è°ƒçˆ¶é—­åŒ…çš„resumeWithæ–¹æ³•ï¼Œå› ä¸ºæˆ‘ä»¬æœ‰ä¸ªåˆ¤ç©ºè¿˜è®°å¾—å—ï¼Ÿï¼š

~~~java
public class LightFutureImpl implements LightFuture, FakerContinuation {

    public boolean isCompleted = false;
    public Object result;
    public FakerContinuation continuation;

    public Object await(FakerContinuation continuation) {
        this.continuation = continuation;
        if (isCompleted) {
            return result;
        }
        return FakerContinuation.SUSPEDN;
    }

    @Override
    public void resumeWith(Object obj) {
        isCompleted = true;
        result = obj;
      	//è¿™é‡Œ
        if (continuation != null) {
            continuation.resumeWith(obj);
        }
    }
}
~~~

æ‰€ä»¥çŠ¶æ€1ä¸€å®šæ˜¯åç¨‹Aè¿›å…¥çš„ï¼

å…¶å®å°±å°†ç»“æœæš‚æ—¶å­˜åˆ°äº†åˆ«çš„åœ°æ–¹ï¼Œä½ å–çš„æ—¶å€™å¯èƒ½æ˜¯ç›´æ¥å–åˆ°ï¼Œä¹Ÿå¯èƒ½è¢«æŒ‚èµ·ï¼Œç­‰åˆ°çˆ¶é—­åŒ…ä¼ é€’è¿›æ¥ã€‚å®ç°äº†ç»“æœçš„åŒæ­¥ï¼Œä½†æ˜¯åˆä¸é˜»å¡çº¿ç¨‹ã€‚ä¸€ä¸ªç®€æ˜“ç‰ˆçš„asyncå°±å®ç°å•¦ï¼

æ³¨æ„ï¼kotlinçš„awaitå®ç°å¾ˆå¤æ‚ï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šç§å…³äºé˜»å¡è¿˜æ˜¯ä¸é˜»å¡çš„è®¨è®º

+ æœ‰äº›äººè¯´awaitå†™æ­»äº†whileé˜»å¡ï¼šï¼ˆæˆ‘ä¸æ˜¯å¾ˆè®¤åŒè¿™ä¸ªè§‚ç‚¹ï¼‰

~~~java
  @Override
    public void resumeWith(@NotNull Object result) {
        synchronized (this){
            this.result = result;
            notifyAll(); // åç¨‹å·²ç»ç»“æŸï¼Œé€šçŸ¥ä¸‹é¢çš„ wait() æ–¹æ³•åœæ­¢é˜»å¡
        }
    }

    public void await() throws Throwable {
        synchronized (this){
            while (true){
                Object result = this.result;
                if(result == null) wait(); // è°ƒç”¨äº† Object.wait()ï¼Œé˜»å¡å½“å‰çº¿ç¨‹ï¼Œåœ¨ notify æˆ–è€… notifyAll è°ƒç”¨æ—¶è¿”å›
                else if(result instanceof Throwable){
                    throw (Throwable) result;
                } else return;
            }
        }
    }
~~~



+ æœ‰äº›äººè¯´æ˜¯ç¼–è¯‘åå°†åŒæ­¥ä»£ç å˜æˆäº†å›è°ƒ(è¿™ä¸ªæœ€ä¸é è°±)

# å°ç»“

å…¶å®kotlinçš„LightFutureä¹Ÿå°±æ˜¯Deferredï¼ŒçœŸæ­£å®ç°æ˜¯CompletableDeferredImplï¼Œæ˜¯ç»§æ‰¿è‡ªJobçš„ï¼Œå› ä¸ºJobæœ‰çŠ¶æ€ï¼Œè€ŒLightFutureä¹Ÿæœ‰ä¸ªå®Œæˆï¼ˆisCompletedï¼‰çŠ¶æ€ã€‚ä½†æ€•ä¿¡æ¯å¤ªå¤æ‚ï¼Œä½ ä¸€ä¸‹çœ‹æ‡µäº†ï¼Œæ‰€ä»¥æˆ‘æ²¡æé‚£ä¹ˆå¤æ‚å»ç»§æ‰¿FakerJobã€‚

kotlinå…³äºawaitçš„æºç è¶…çº§å¤æ‚ï¼Œçœ‹ç€çœ‹ç€ä¼šæ‡µé€¼ï¼Œè€Œä¸”ç”±äºé»‘é­”æ³•çš„å­˜åœ¨ï¼Œç›´æ¥çœ‹kotlinå±‚çš„æºç æˆ‘æ„Ÿè§‰ä¼šçœ‹å‚»äººã€‚è¿™é‡Œä½ å¯èƒ½æœ‰ä¸¤ä¸ªç–‘é—®ï¼š

1. æˆ‘æ€ä¹ˆè¯æ˜æœ¬æ–‡ä¸­çš„awaitå®ç°æ˜¯å¯¹çš„ï¼Ÿ
2. å¦‚æœæ¯æ¬¡æƒ³è¦ç”¨javaå®ç°åç¨‹ï¼Œé‚£ä¸æ˜¯éƒ½å¾—å†™switchï¼Ÿé‚£ä»£ç ä¸æ˜¯åˆé•¿åˆè‡­ï¼Ÿ

# é»‘é­”æ³•

å›ç­”é—®é¢˜1 ï¼š

> æˆ‘æ€ä¹ˆè¯æ˜æœ¬æ–‡ä¸­çš„awaitå®ç°æ˜¯å¯¹çš„ï¼Ÿæˆ‘ä¸ä¸ä¿è¯æˆ‘ä¸€å®šæ­£ç¡®ï¼Œæˆ‘æ˜¯é˜…è¯»äº†kotlinä»£ç decompileåçš„javaä»£ç ï¼Œè®¤ä¸ºå®ç°æ–¹å¼å¯èƒ½æ˜¯è¿™æ ·ï¼Œä¸‹æ–‡ä¼šç»™å‡ºdecompileåçš„javaä»£ç å’Œkotlinä»£ç çš„å¯¹æ¯”ã€‚

å›ç­”é—®é¢˜2ï¼š

> æ²¡åŠæ³•ï¼Œjavaæœ¬èº«å°±ä¸æ”¯æŒåç¨‹ï¼Œä½†å› ä¸ºåç¨‹æ˜¯è¯­è¨€å±‚é¢çš„ä¸œè¥¿ï¼Œæ‰€ä»¥æˆ‘æ‰èƒ½å®Œå…¨é€šè¿‡javaä»£ç å®ç°åç¨‹ã€‚ä¸‹æ–‡ä¼šç»™å‡ºdecompileåçš„javaä»£ç ï¼Œä½ å°±çŸ¥é“ä¸ºä»€ä¹ˆkotlinå†™ä¸ªåç¨‹è¿™ä¹ˆç®€å•äº†ã€‚

é»‘é­”æ³•æ˜¯æŒ‡ç¼–è¯‘å™¨å¯¹æˆ‘ä»¬å†™ä¸‹çš„kotlinä»£ç åšäº†å¤„ç†ï¼Œä¾‹å¦‚æˆ‘ä»¬å†™ä¸‹çš„æ˜¯è¿™æ ·çš„ä»£ç ï¼š

~~~java
    suspend fun showHtmlPage() = runBlocking {
        val resultA = async { loadResource("addrA") }
        val resultB = async { loadResource("addrB") }
        Log.d(">>>", resultA.await().toString()+resultB.await().toString())
    }
~~~

decompileåçš„javaä»£ç æ˜¯è¿™æ ·çš„ï¼š

å¦‚æœä½ ç†è§£äº†ä¸Šæ–‡çš„æ‰€æœ‰æ€æƒ³ï¼Œç›¸ä¿¡çœ‹æ‡‚è¿™éƒ¨åˆ†ä»£ç ä¸€å®šä¸éš¾ï¼Œç»™ç‚¹è€å¿ƒï¼š

~~~java
   public final Object showHtmlPage(@NotNull Continuation $completion) {
      return BuildersKt.runBlocking$default((CoroutineContext)null, (Function2)(new Function2((Continuation)null) {
         // $FF: synthetic field
         private Object L$0;
         Object L$1;
         Object L$2;
         int label;

         @Nullable
         public final Object invokeSuspend(@NotNull Object $result) {
            Object var10000;
            String var5;
            StringBuilder var6;
            Object var7;
            label17: {
               Object var8 = IntrinsicsKt.getCOROUTINE_SUSPENDED();
               Deferred resultB;
               switch(this.label) {
               case 0:
                  ResultKt.throwOnFailure($result);
                  CoroutineScope $this$runBlocking = (CoroutineScope)this.L$0;
                  //æ³¨æ„è¿™
                  Deferred resultA = BuildersKt.async$default($this$runBlocking, (CoroutineContext)null, (CoroutineStart)null, (Function2)(new Function2((Continuation)null) {
                     int label;

                     @Nullable
                     public final Object invokeSuspend(@NotNull Object var1) {
                        Object var2 = IntrinsicsKt.getCOROUTINE_SUSPENDED();
                        switch(this.label) {
                        case 0:
                           ResultKt.throwOnFailure(var1);
                           return MainActivity.this.loadResource("addrA");
                        default:
                           throw new IllegalStateException("call to 'resume' before 'invoke' with coroutine");
                        }
                     }

                     @NotNull
                     public final Continuation create(@Nullable Object value, @NotNull Continuation completion) {
                        Intrinsics.checkNotNullParameter(completion, "completion");
                        Function2 var3 = new <anonymous constructor>(completion);
                        return var3;
                     }

                     public final Object invoke(Object var1, Object var2) {
                        return ((<undefinedtype>)this.create(var1, (Continuation)var2)).invokeSuspend(Unit.INSTANCE);
                     }
                  }), 3, (Object)null);
                  //æ³¨æ„è¿™é‡Œ
                  resultB = BuildersKt.async$default($this$runBlocking, (CoroutineContext)null, (CoroutineStart)null, (Function2)(new Function2((Continuation)null) {
                     int label;

                     @Nullable
                     public final Object invokeSuspend(@NotNull Object var1) {
                        Object var2 = IntrinsicsKt.getCOROUTINE_SUSPENDED();
                        switch(this.label) {
                        case 0:
                           ResultKt.throwOnFailure(var1);
                           return MainActivity.this.loadResource("addrB");
                        default:
                           throw new IllegalStateException("call to 'resume' before 'invoke' with coroutine");
                        }
                     }

                     @NotNull
                     public final Continuation create(@Nullable Object value, @NotNull Continuation completion) {
                        Intrinsics.checkNotNullParameter(completion, "completion");
                        Function2 var3 = new <anonymous constructor>(completion);
                        return var3;
                     }

                     public final Object invoke(Object var1, Object var2) {
                        return ((<undefinedtype>)this.create(var1, (Continuation)var2)).invokeSuspend(Unit.INSTANCE);
                     }
                  }), 3, (Object)null);
                  var6 = new StringBuilder();
                  var5 = ">>>";
                  this.L$0 = resultB;
                  this.L$1 = var5;
                  this.L$2 = var6;
                  this.label = 1;
                  //æ³¨æ„è¿™é‡Œï¼
                  var10000 = resultA.await(this);
                  if (var10000 == var8) {
                     return var8;
                  }
                  break;
               case 1:
                  var6 = (StringBuilder)this.L$2;
                  var5 = (String)this.L$1;
                  resultB = (Deferred)this.L$0;
                  ResultKt.throwOnFailure($result);
                  var10000 = $result;
                  break;
               case 2:
                  var6 = (StringBuilder)this.L$1;
                  var5 = (String)this.L$0;
                  ResultKt.throwOnFailure($result);
                  var10000 = $result;
                  //æ³¨æ„è¿™é‡Œ
                  break label17;
               default:
                  throw new IllegalStateException("call to 'resume' before 'invoke' with coroutine");
               }

               var7 = var10000;
               var6 = var6.append(String.valueOf(var7));
               var5 = var5;
               this.L$0 = var5;
               this.L$1 = var6;
               this.L$2 = null;
              //æ³¨æ„è¿™é‡Œ
               this.label = 2;
               var10000 = resultB.await(this);
               if (var10000 == var8) {
                  return var8;
               }
            }

            var7 = var10000;
           //æ³¨æ„è¿™é‡Œ
            return Boxing.boxInt(Log.d(var5, var6.append(String.valueOf(var7)).toString()));
         }

         @NotNull
         public final Continuation create(@Nullable Object value, @NotNull Continuation completion) {
            Intrinsics.checkNotNullParameter(completion, "completion");
            Function2 var3 = new <anonymous constructor>(completion);
            var3.L$0 = value;
            return var3;
         }

         public final Object invoke(Object var1, Object var2) {
            return ((<undefinedtype>)this.create(var1, (Continuation)var2)).invokeSuspend(Unit.INSTANCE);
         }
      }), 1, (Object)null);
   }

   private final String loadResource(String addr) {
      try {
         if (Intrinsics.areEqual(addr, "A")) {
            Thread.sleep(2000L);
         } else {
            Thread.sleep(1000L);
         }
      } catch (InterruptedException var3) {
         var3.printStackTrace();
      }

      return "load end " + addr;
   }
~~~

å¯ä»¥çœ‹åˆ°æ— è®ºåç¨‹é‡Œé¢åšäº†å•¥ï¼Œéƒ½ä¼šç”Ÿæˆswitchè¯­å¥ï¼Œæˆ‘ä¼°è®¡æ˜¯ä¸ºäº†ç»Ÿä¸€ç”Ÿæˆå§ã€‚

å’Œæˆ‘ä¸Šæ–‡å®ç°çš„æ˜¯ä¸æ˜¯å·®ä¸å¤šï¼Ÿæ‰€ä»¥åˆ°åº•asyncåˆ°åº•å¦‚ä½•å®ç°çš„ï¼Œæˆ‘å°±æ˜¯é€šè¿‡è¿™é‡Œå¾—å‡ºçš„ç»“è®ºï¼Œå¹¶ä¸”å†™å‡ºäº†æµ‹è¯•ä»£ç ï¼Œå¾—å‡ºçš„ç»“æœä¹Ÿæ¯”è¾ƒç¬¦åˆkotlinçš„asyncã€‚æˆ‘å·¥ä½œä¸åˆ°ä¸€å¹´ï¼Œæ°´å¹³æœ‰é™ï¼Œæ‰€ä»¥çœŸæ­£çš„å®ç°æ–¹å¼è¿˜æ˜¯å¾—å¤§å®¶ä¼™éƒ½å»å­¦ä¹ å»åˆ†æè®ºè¯ã€‚

å¦‚æœä½ ä¸çº ç»“å®ç°æ–¹å¼ï¼Œè€Œæ˜¯æ€æƒ³ï¼Œæˆ‘å¾ˆé«˜å…´ä½ getåˆ°äº†æˆ‘å¸Œæœ›è¯»è€…getåˆ°çš„ç‚¹ï¼šæˆ‘è®¤ä¸ºä¸Šæ–‡ä¸­æˆ‘å°†ç»“æœå­˜å‚¨ï¼Œåœ¨åˆé€‚çš„æ—¶å€™å›è°ƒçˆ¶åç¨‹ï¼Œé€šè¿‡çˆ¶åç¨‹çš„çŠ¶æ€æœºé‡æ–°æ‰§è¡Œå¯¹äºçš„ä»£ç çš„æ€æƒ³æ‰æ˜¯æœ€é‡è¦çš„ï¼å› ä¸ºç¡®ç¡®å®å®å®ç°äº†å‡ ä¸ªåç¨‹çš„æµè½¬ï¼Œä»¥åŠæ‰§è¡Œç»“æœçš„åŒæ­¥ï¼Œè€Œä¸”æ²¡æœ‰é˜»å¡ï¼

# ç»“

kotlinçš„åç¨‹è¿˜æœ‰å¾ˆå¤šæˆ‘æ²¡æåˆ°çš„å¼ºå¤§åŠŸèƒ½ï¼Œå› ä¸ºå†™æœ¬æ–‡çš„æƒ³æ³•å¾ˆç®€å•ï¼šå°±æ˜¯æƒ³çŸ¥é“kotlinçš„åç¨‹æ˜¯å¦‚ä½•ä½¿ç”¨é—­åŒ…å®ç°çš„ã€‚æˆ‘è§‰å¾—ä¸Šæ–‡å†™çš„å¾ˆç®€å•äº†ï¼Œå°±ç®—è¡¨è¿°ä¸è¡Œï¼Œä½ è·‘ä¸€ä¸‹ä»£ç å°±èƒ½æç„¶å¤§æ‚Ÿï¼æˆ‘çœŸçš„å°½åŠ›äº†é“å­ä»¬ğŸ˜­ï¼Œå¸Œæœ›ä½ ä»¬è¯»å®Œè¿™ä¸€ä¸‡å¤šä¸ªå­—èƒ½æœ‰æ”¶è·ï¼